<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
  <meta charset="UTF-8">
  <title>DEMATEL å•å·èª¿æŸ¥ç³»çµ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: "Segoe UI", "å¾®è»Ÿæ­£é»‘é«”", Arial, sans-serif; 
      font-size: small;
      background: #fefae0;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      max-width: 900px;
      width: 100%;
      background: #fefae0;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      border: 2px solid #ccd5ae;
    }
    .header {
      background: #ccd5ae;
      color: #333;
      padding: 20px 30px;
      text-align: center;
    }
    .header h1 {
      margin: 0;
      font-size: 1.8em;
      font-weight: 600;
    }
    .header p {
      margin: 10px 0 0 0;
      opacity: 0.9;
      font-size: 1em;
    }
    
    /* é€²åº¦æ¢ */
    .progress-bar {
      background: rgba(188, 108, 37, 0.2);
      height: 8px;
      border-radius: 4px;
      margin-top: 15px;
      overflow: hidden;
    }
    .progress-fill {
      background: #d4a373;
      height: 100%;
      width: 0%;
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    .progress-text {
      margin-top: 10px;
      font-size: 0.9em;
      opacity: 0.9;
      text-align: center;
      line-height: 1.4;
    }
    
    .content {
      padding: 30px;
      color: #333;
    }
    
    /* èªªæ˜é é¢ */
    .intro-section {
      margin-bottom: 30px;
    }
    .intro-content {
      background: #fff9f9;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      line-height: 1.8;
      border-left: 4px solid #d4a373;
    }
    .intro-content p {
      margin-bottom: 15px;
      color: #333;
    }
    .intro-content ul {
      margin: 15px 0;
      padding-left: 20px;
    }
    .intro-content li {
      margin-bottom: 8px;
      color: #555;
    }
    .intro-content strong {
      color: #1e3c72;
      font-weight: 600;
    }
    
    /* åŸºæœ¬è³‡æ–™è¡¨å–® */
    .form-section {
      margin-bottom: 30px;
    }
    .form-title {
      font-size: 1.4em;
      color: #1e3c72;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e0e0e0;
      font-weight: 600;
      text-align: left;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
      text-align: left;
    }
    .form-label.required::after {
      content: " *";
      color: #d4a373;
    }
    .form-input, .form-select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #ccd5ae;
      border-radius: 8px;
      font-size: 1em;
      transition: border-color 0.3s ease;
      background: #fefae0;
      color: #333;
    }
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: #d4a373;
    }
    .form-input.error, .form-select.error {
      border-color: #d4a373;
    }
    .form-description {
      font-size: 0.9em;
      color: #666;
      margin-top: 5px;
    }
    .checkbox-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      padding: 8px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      transition: background-color 0.2s ease;
    }
    .checkbox-item:hover {
      background-color: #f8f9fa;
    }
    .checkbox-item input[type="checkbox"] {
      margin-right: 8px;
    }
    
    /* å•å·éƒ¨åˆ† */
    .survey-section {
      display: none;
      text-align: center;
    }
    .phase-title {
      font-size: 1.3em;
      color: #333;
      text-align: center;
      font-weight: 600;
      margin-bottom: 15px;
      padding: 15px;
      background: #e9edc9;
      border-radius: 12px;
      border: 2px solid #ccd5ae;
    }
    .step-title {
      font-size: 1.2em;
      margin-bottom: 25px;
      font-weight: 600;
      color: #333;
      text-align: left;
    }
    .desc-row {
      display: flex;
      justify-content: center;
      align-items: stretch;
      gap: 30px;
      margin-bottom: 25px;
    }
    .desc-block {
      flex: 1;
      max-width: 350px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .block-title {
      font-size: 1.2em;
      color: #1e3c72;
      background: linear-gradient(135deg, #f0f4fa 0%, #e0e8f0 100%);
      font-weight: 600;
      border-radius: 12px;
      padding: 8px 20px;
      margin-bottom: 12px;
      text-align: center;
      border: 2px solid #e0e8f0;
    }
    .block-vs {
      color: #666;
      font-size: 1.3em;
      margin: 0 15px;
      font-weight: 600;
      align-self: center;
    }
    .desc-content {
      text-align: center;
      line-height: 1.6;
      color: #555;
    }
    .relation-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 25px;
    }
    .btn, .score-btn {
      border: none;
      border-radius: 10px;
      padding: 15px 20px;
      background: #e9edc9;
      color: #333;
      font-size: 1.1em;
      cursor: pointer;
      transition: all 0.3s ease;
      outline: none;
      width: 100%;
      text-align: center;
      font-weight: 500;
      border: 2px solid #ccd5ae;
    }
    .btn:hover, .score-btn:hover {
      background: #ccd5ae;
      color: #333;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .btn.selected, .score-btn.selected {
      background: #d4a373 !important;
      color: #333 !important;
      font-weight: 600 !important;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(212, 163, 115, 0.3);
      border-color: #d4a373 !important;
    }
    .score-group {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      justify-content: center;
    }
    .score-title {
      margin-bottom: 8px;
      color: #e55353;
      font-size: 1.1em;
      font-weight: 600;
    }
    
    /* åˆ†æ•¸é¸æ“‡å€åŸŸæ¨£å¼ */
    .score-section {
      background: #fefcf3;
      border: 2px solid #d4a373;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 8px rgba(212, 163, 115, 0.2);
    }
    
    .selected-relation {
      background: #e9edc9;
      color: #333;
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.95em;
      text-align: center;
      margin-bottom: 15px;
    }
    
    /* é«˜äº®å‹•ç•« */
    @keyframes pulseHighlight {
      0% { box-shadow: 0 2px 8px rgba(212, 163, 115, 0.2); }
      50% { box-shadow: 0 4px 20px rgba(212, 163, 115, 0.6); }
      100% { box-shadow: 0 2px 8px rgba(212, 163, 115, 0.2); }
    }
    
    /* æ‡¸æµ®è¦–çª—æ¨£å¼ */
    .score-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
      align-items: center;
      justify-content: center;
    }
    
    .score-modal.modal-show {
      opacity: 1;
    }
    
    .modal-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
    }
    
    .modal-content {
      background: #fefcf3;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      transform: scale(0.8);
      transition: transform 0.3s ease;
    }
    
    .score-modal.modal-show .modal-content {
      transform: scale(1);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 25px 15px;
      border-bottom: 2px solid #e9edc9;
    }
    
    .modal-title {
      margin: 0;
      color: #333;
      font-size: 1.3em;
      font-weight: 600;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 1.8em;
      cursor: pointer;
      color: #666;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s ease;
    }
    
    .modal-close:hover {
      background: #e9edc9;
      color: #333;
    }
    
    .modal-body {
      padding: 20px 25px 25px;
    }
    
    .modal-relation-info {
      background: #e9edc9;
      color: #333;
      padding: 12px 20px;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 20px;
      font-weight: 600;
      font-size: 1.1em;
    }
    
    .modal-score-section {
      margin-bottom: 25px;
    }
    
    .modal-score-section:last-child {
      margin-bottom: 0;
    }
    
    .modal-score-title {
      margin-bottom: 12px;
      color: #e55353;
      font-size: 1.1em;
      font-weight: 600;
      text-align: center;
    }
    
    .modal-score-group {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-bottom: 15px;
    }
    
    .modal-score-btn {
      padding: 15px 20px;
      border: 2px solid #e9edc9;
      border-radius: 8px;
      background: #faedcd;
      color: #333;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1.2em;
      font-weight: 600;
      min-width: 50px;
    }
    
    .modal-score-btn:hover {
      background: #e9edc9;
      border-color: #ccd5ae;
      transform: translateY(-2px);
    }
    
    .modal-score-btn.selected {
      background: #d4a373 !important;
      color: #333 !important;
      font-weight: 700 !important;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(212, 163, 115, 0.4);
      border-color: #d4a373 !important;
    }
    .progress {
      color: #666;
      margin-bottom: 20px;
      text-align: center;
      font-size: 0.95em;
    }
    
    /* æ§åˆ¶æŒ‰éˆ• */
    .control-buttons {
      display: flex;
      gap: 15px;
      margin-top: 30px;
      justify-content: center;
    }
    .control-btn {
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      font-size: 1.1em;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      min-width: 120px;
    }
    .prev-btn {
      background: #faedcd;
      color: #333;
      border: 2px solid #e9edc9;
    }
    .prev-btn:hover {
      background: #e9edc9;
      border-color: #ccd5ae;
    }
    .next-btn {
      background: #d4a373;
      color: #333;
      border: 2px solid #ccd5ae;
    }
    .next-btn:hover {
      background: #ccd5ae;
      border-color: #d4a373;
    }
    .next-btn:disabled {
      background: #ffcdd2;
      cursor: not-allowed;
    }
    
    /* å®Œæˆé é¢ */
    .finish-section {
      display: none;
    }
    .finish-title {
      font-size: 1.6em;
      color: #28a745;
      margin-bottom: 20px;
      text-align: center;
    }
    .qr-section {
      margin-top: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
    }
    
    /* RWD éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 768px) {
      body { 
        padding: 10px; 
        align-items: flex-start;
      }
      .container { 
        border-radius: 15px;
        margin: 10px auto;
      }
      .header { padding: 15px 20px; }
      .header h1 { font-size: 1.5em; }
      .content { padding: 20px; }
      .desc-row {
        flex-direction: column;
        gap: 15px;
        align-items: center;
      }
      .desc-block {
        width: 100%;
        max-width: none;
      }
      .block-vs { margin: 10px 0; }
      .checkbox-group {
        grid-template-columns: 1fr;
      }
      .control-buttons {
        flex-direction: column;
      }
      .control-btn {
        width: 100%;
      }
    }
    @media (max-width: 480px) {
      body {
        padding: 5px;
        align-items: flex-start;
      }
      .container {
        width: calc(100% - 10px);
        margin: 5px auto;
      }
      .header { padding: 12px 15px; }
      .header h1 { font-size: 1.3em; }
      .content { padding: 15px; }
      .btn, .score-btn { padding: 12px 15px; font-size: 1em; }
      .desc-row {
        flex-direction: column;
        gap: 10px;
        align-items: center;
      }
      .desc-block {
        width: 100%;
        text-align: center;
      }
      
      /* æ‰‹æ©Ÿç‰ˆåˆ†æ•¸é¸æ“‡å€åŸŸ */
      .selected-relation {
        text-align: center;
        font-size: 0.9em;
      }
      
      /* æ‰‹æ©Ÿç‰ˆæ‡¸æµ®è¦–çª— */
      .modal-content {
        width: 95%;
        max-height: 90vh;
      }
      
      .modal-header {
        padding: 15px 20px 10px;
      }
      
      .modal-title {
        font-size: 1.1em;
      }
      
      .modal-body {
        padding: 15px 20px 20px;
      }
      
      .modal-score-group {
        gap: 10px;
      }
      
      .modal-score-btn {
        padding: 12px 15px;
        font-size: 1.1em;
        min-width: 45px;
      }
    }
    
    /* QR Code ç›¸é—œæ¨£å¼ */
    .qr-segments {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      align-items: flex-start;
      margin: 30px auto;
      max-width: 1000px;
    }
    .qr-segment {
      text-align: center;
      min-width: 250px;
      max-width: 300px;
      padding: 20px;
      background: #fefae0;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border: 2px solid #ccd5ae;
    }
    .qr-segment h4 {
      margin: 0 0 15px 0;
      color: #333;
      font-size: 1.1em;
      font-weight: 600;
    }
    .qr-segment > div {
      display: flex;
      justify-content: center;
      margin: 15px 0;
    }
    .verification-area {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }
    .verification-area h3 {
      color: #1e3c72;
      margin-bottom: 12px;
    }
    .verification-input {
      width: 100%;
      height: 120px;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 8px;
      font-family: monospace;
      font-size: 0.9em;
    }
    .verify-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 8px;
    }
    .verify-btn:hover {
      background: #218838;
    }
    .result-area {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 12px;
      margin-top: 8px;
      font-family: monospace;
      font-size: 0.8em;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>DEMATEL å•å·èª¿æŸ¥ç³»çµ±</h1>
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
    <div class="progress-text" id="progressText">æº–å‚™é–‹å§‹...</div>
  </div>

  <div class="content">
    <!-- èªªæ˜é é¢ -->
    <div class="intro-section" id="introSection" style="display: block;">
      <div class="form-title" id="introTitle">å•å·èªªæ˜</div>
      <div class="intro-content" id="introContent">
        <p>è¦ªæ„›çš„å—è¨ªè€…ï¼Œæ‚¨å¥½ï¼</p>
        <p>æœ¬ç ”ç©¶æ—¨åœ¨æ¢è¨æ•¸ä½æ™‚ä»£ä¸‹å„é …èƒ½åŠ›ä¹‹é–“çš„å½±éŸ¿é—œä¿‚ï¼Œä»¥å»ºæ§‹å®Œæ•´çš„èƒ½åŠ›æ¡†æ¶ã€‚</p>
        <p><strong>æœ¬å•å·åˆ†ç‚ºä¸‰å€‹éƒ¨åˆ†ï¼š</strong></p>
        <p style="margin-left: 15px;">1. åŸºæœ¬è³‡æ–™ï¼šè«‹å¡«å¯«æ‚¨çš„å€‹äººåŸºæœ¬è³‡è¨Š</p>
        <p style="margin-left: 15px;">2. æº–å‰‡æ¯”è¼ƒï¼šè©•ä¼°å„é …èƒ½åŠ›æŒ‡æ¨™ä¹‹é–“çš„å½±éŸ¿é—œä¿‚</p>
        <p style="margin-left: 15px;">3. æ§‹é¢æ¯”è¼ƒï¼šè©•ä¼°å„å¤§èƒ½åŠ›æ§‹é¢ä¹‹é–“çš„å½±éŸ¿é—œä¿‚</p>
        <br>
        <p><strong>å¡«å¯«èªªæ˜ï¼š</strong></p>
        <p style="margin-left: 15px;">â€¢ è«‹ä»”ç´°é–±è®€æ¯å€‹é¡Œç›®çš„èªªæ˜</p>
        <p style="margin-left: 15px;">â€¢ æ ¹æ“šæ‚¨çš„å¯¦éš›ç¶“é©—é€²è¡Œåˆ¤æ–·</p>
        <p style="margin-left: 15px;">â€¢ å¦‚æœå…©é …èƒ½åŠ›ç„¡é—œï¼Œè«‹é¸æ“‡ã€Œå…©è€…ç„¡é—œã€</p>
        <p style="margin-left: 15px;">â€¢ å¦‚æœæœ‰å½±éŸ¿é—œä¿‚ï¼Œè«‹é¸æ“‡å½±éŸ¿æ–¹å‘ä¸¦è©•ä¼°å½±éŸ¿ç¨‹åº¦(1=ä½å½±éŸ¿, 4=é«˜å½±éŸ¿)</p>
        <p style="margin-left: 15px;">â€¢ å…¨ç¨‹ç´„éœ€15-20åˆ†é˜</p>
        <br>
        <p>æ‚¨çš„å›ç­”å°ç ”ç©¶éå¸¸é‡è¦ï¼Œæ‰€æœ‰è³‡æ–™åƒ…ä¾›å­¸è¡“ç ”ç©¶ä½¿ç”¨ï¼Œçµ•å°ä¿å¯†ã€‚</p>
        <p>æ„Ÿè¬æ‚¨çš„åƒèˆ‡ï¼</p>
      </div>
      <div class="control-buttons">
        <button class="control-btn next-btn" id="introNextBtn" onclick="showBasicInfo()">é–‹å§‹å¡«å¯«</button>
      </div>
    </div>

    <!-- åŸºæœ¬è³‡æ–™å¡«å¯« -->
    <div class="survey-section" id="basicInfoSection" style="display: none;">
      <div class="form-title">ç¬¬ä¸€éƒ¨åˆ†ï¼šåŸºæœ¬è³‡æ–™å¡«å¯«</div>
      <div class="intro-content" style="background: #fff9f9; border-left: 4px solid #d4a373;">
        <div id="basicInfoForm"></div>
        <div class="control-buttons">
          <button class="control-btn next-btn" id="basicNextBtn" onclick="proceedToSurvey()">é–‹å§‹å•å· â†’</button>
        </div>
      </div>
    </div>

    <!-- å•å·éƒ¨åˆ† -->
    <div class="survey-section" id="surveySection">
      <div id="main"></div>
    </div>

    <!-- å®Œæˆé é¢ -->
    <div class="finish-section" id="finishSection">
      <div class="form-title">å•å·å¡«å¯«å®Œæˆ</div>
      <div class="intro-content" style="background: #fff9f9; border-left: 4px solid #28a745;">
        <div class="finish-title">ğŸ‰ å•å·å¡«å¯«å®Œæˆï¼</div>
        <p>æ„Ÿè¬æ‚¨åƒèˆ‡æœ¬æ¬¡å•å·èª¿æŸ¥ï¼Œæ‚¨çš„æ„è¦‹å°æˆ‘å€‘éå¸¸é‡è¦ï¼</p>
        <p>è«‹é»é¸ä¸‹æ–¹æŒ‰éˆ•ç”¢ç”ŸQR Codeï¼Œä¸¦å°‡æ‰€æœ‰QR Codeæˆªåœ–å›å‚³çµ¦ç ”ç©¶äººå“¡ã€‚</p>
        
        <div class="qr-section">
          <div style="display:flex;justify-content:center;gap:15px;margin-bottom:20px;flex-wrap:wrap;">
            <button class="control-btn next-btn" onclick="validateAndDownload()">ä¸‹è¼‰çµæœ (JSON)</button>
            <button class="control-btn next-btn" style="background: #d4a373; border-color: #ccd5ae;" onclick="validateAndShowQRCode()">ç”¢ç”Ÿ QRCode</button>
          </div>
          
          <div id="qrcode-wrap" style="display:none;">
            <div id="qrcode-segments" class="qr-segments"></div>
            <button class="control-btn prev-btn" style="margin-top:15px;" onclick="hideQRCode()">æ”¶èµ· QR Code</button>
            
            <!-- é©—è­‰å€åŸŸ -->
            <div class="verification-area">
              <h3>QR Code é©—è­‰èˆ‡é‚„åŸ</h3>
              <textarea class="verification-input" id="verificationInput" placeholder="è«‹è²¼å…¥ä¸€å€‹æˆ–å¤šå€‹ base64 ç·¨ç¢¼çš„ç‰‡æ®µï¼ˆæ¯è¡Œä¸€å€‹ï¼‰&#10;æ ¼å¼ç¯„ä¾‹ï¼š&#10;{&quot;i&quot;:0,&quot;total&quot;:2,&quot;part&quot;:&quot;eJy...&quot;}&#10;{&quot;i&quot;:1,&quot;total&quot;:2,&quot;part&quot;:&quot;xyz...&quot;}"></textarea>
              <button class="verify-btn" onclick="verifyAndRestore()">é©—è­‰ä¸¦é‚„åŸ</button>
              <div class="result-area" id="verificationResult"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- å‹•ç•«æœŸé–“çš„ç¦ç”¨è¦†è“‹å±¤ -->
<div id="animationOverlay" class="animation-overlay"></div>

<!-- è¨ºæ–·å·¥å…· (é–‹ç™¼ç”¨ï¼Œæ­£å¼ç‰ˆå¯ç§»é™¤) -->
<div id="debugPanel" style="position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 5px; font-size: 12px; z-index: 10000; display: none;">
  <div>localStorage è¨ºæ–·</div>
  <button onclick="toggleDebugPanel()" style="margin: 5px 0; padding: 2px 5px;">éš±è—</button>
  <button onclick="checkLocalStorage()" style="margin: 5px 0; padding: 2px 5px;">æª¢æŸ¥å„²å­˜</button>
  <button onclick="clearDebugStorage()" style="margin: 5px 0; padding: 2px 5px;">æ¸…é™¤å„²å­˜</button>
  <div id="debugInfo"></div>
</div>
<button onclick="toggleDebugPanel()" style="position: fixed; bottom: 10px; right: 10px; z-index: 9999; padding: 5px 10px; background: #333; color: white; border: none; border-radius: 3px; font-size: 12px;">Debug</button>

<script>
// å…¨å±€è®Šé‡
let questions = [], answers = {}, basicInfo = {}, idx = 0, fileName = 'dematel-structure.json';
let rel = '', score1 = '', score2 = '';
let critTotal = 0, dimTotal = 0;
let currentPhase = 'intro'; // intro, basic, survey, finish
let surveyData = null;
let isAnimating = false; // è¿½è¹¤å‹•ç•«ç‹€æ…‹ï¼Œé˜²æ­¢é€£çºŒé»æ“Š

// å‹•ç•«æ™‚åºå¸¸æ•¸
const PAGE_ANIM_MS = 400;           // ç¿»é å‹•ç•«ç¸½æ™‚é•·
const CLEAR_DELAY = PAGE_ANIM_MS / 2; // æ¸…é™¤é¸ä¸­ç‹€æ…‹çš„å»¶é²æ™‚é–“

const LS_KEY = 'dematel_answers';
const LS_BASIC_KEY = 'dematel_basic_info';

// è¨ºæ–·å·¥å…·å‡½æ•¸
function toggleDebugPanel() {
  const panel = document.getElementById('debugPanel');
  const button = document.querySelector('button[onclick="toggleDebugPanel()"]');
  if (panel.style.display === 'none' || !panel.style.display) {
    panel.style.display = 'block';
    button.style.display = 'none';
    checkLocalStorage(); // è‡ªå‹•æª¢æŸ¥ç‹€æ…‹
  } else {
    panel.style.display = 'none';
    button.style.display = 'block';
  }
}

function checkLocalStorage() {
  const debugInfo = document.getElementById('debugInfo');
  const answersData = localStorage.getItem(LS_KEY);
  const phaseData = localStorage.getItem('dematel-phase');
  const idxData = localStorage.getItem('dematel-idx');
  
  let info = '<div style="margin-top: 10px; font-size: 11px;">';
  info += '<strong>ç•¶å‰ç‹€æ…‹:</strong><br>';
  info += `idx: ${idx} (å·²å®Œæˆ ${idx} é¡Œï¼Œé¡¯ç¤ºç¬¬ ${idx + 1} é¡Œ)<br>`;
  info += `currentPhase: ${currentPhase}<br>`;
  info += `å·²å›ç­”é¡Œæ•¸: ${Object.keys(answers).length}<br>`;
  info += `ç¸½é¡Œæ•¸: ${questions.length}<br><br>`;
  
  info += '<strong>localStorage:</strong><br>';
  info += `dematel_answers: ${answersData ? 'âœ“' : 'âœ—'}<br>`;
  info += `dematel-phase: ${phaseData || 'ç„¡'}<br>`;
  info += `dematel-idx: ${idxData || 'ç„¡'}<br><br>`;
  
  if (answersData) {
    try {
      const parsed = JSON.parse(answersData);
      info += `ç­”æ¡ˆæ•¸é‡: ${Object.keys(parsed).length}<br>`;
      info += '<strong>æœ€è¿‘3å€‹ç­”æ¡ˆ:</strong><br>';
      const entries = Object.entries(parsed);
      entries.slice(-3).forEach(([key, value]) => {
        info += `${key}: ${JSON.stringify(value)}<br>`;
      });
    } catch(e) {
      info += 'ç­”æ¡ˆè§£æéŒ¯èª¤<br>';
    }
  }
  
  info += '</div>';
  debugInfo.innerHTML = info;
}

function clearDebugStorage() {
  if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å„²å­˜çš„è³‡æ–™å—ï¼Ÿ')) {
    clearAllData();
    alert('å·²æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Œé é¢å³å°‡é‡æ–°æ•´ç†');
    // çŸ­æš«å»¶é²å¾Œé‡æ–°æ•´ç†é é¢
    setTimeout(() => {
      location.reload();
    }, 500);
  }
}

// ç¦ç”¨é é¢äº¤äº’ï¼ˆå‹•ç•«æœŸé–“ï¼‰
function disablePageInteraction() {
  isAnimating = true;
  const overlay = document.getElementById('animationOverlay');
  if (overlay) {
    overlay.style.display = 'block';
  }
  
  // ç¦ç”¨æ‰€æœ‰æŒ‰éˆ•
  const buttons = document.querySelectorAll('button, .btn, .control-btn');
  buttons.forEach(btn => {
    btn.disabled = true;
  });
}

// å•Ÿç”¨é é¢äº¤äº’ï¼ˆå‹•ç•«å®Œæˆå¾Œï¼‰
function enablePageInteraction() {
  isAnimating = false;
  const overlay = document.getElementById('animationOverlay');
  if (overlay) {
    overlay.style.display = 'none';
  }
  
  // å•Ÿç”¨æ‰€æœ‰æŒ‰éˆ•
  const buttons = document.querySelectorAll('button, .btn, .control-btn');
  buttons.forEach(btn => {
    btn.disabled = false;
  });
}

// é€²åº¦æ›´æ–°å‡½æ•¸
function updateProgress() {
  const progressFill = document.getElementById('progressFill');
  const progressText = document.getElementById('progressText');
  
  if (currentPhase === 'intro') {
    progressFill.style.width = '5%';
    progressText.textContent = 'é–±è®€èªªæ˜ä¸­...';
  } else if (currentPhase === 'basic') {
    progressFill.style.width = '10%';
    progressText.textContent = 'ç¬¬ä¸€éƒ¨åˆ†ï¼šåŸºæœ¬è³‡æ–™å¡«å¯«';
  } else if (currentPhase === 'survey') {
    const totalQuestions = questions.length;
    const progress = totalQuestions > 0 ? ((idx / totalQuestions) * 70) + 15 : 15;
    progressFill.style.width = progress + '%';
    
    // è¨ˆç®—ç•¶å‰é€²åº¦çµ±è¨ˆ (idx æ˜¯ç•¶å‰é¡Œç›®çš„ç´¢å¼•ï¼Œå¾0é–‹å§‹)
    // ç•¶å‰é¡Œè™Ÿ = idx + 1ï¼Œå·²å®Œæˆé¡Œæ•¸ = idx
    let currentQuestionNumber = idx + 1;
    let critNow = 0;
    let dimNow = 0;
    
    if (idx < critTotal) {
      // é‚„åœ¨æº–å‰‡é¡Œç›®éšæ®µ
      critNow = currentQuestionNumber;
      dimNow = 0;
    } else {
      // åœ¨æ§‹é¢é¡Œç›®éšæ®µ
      critNow = critTotal;
      dimNow = currentQuestionNumber - critTotal;
    }
    
    let percent = Math.floor((idx / totalQuestions) * 100);
    
    // é¡¯ç¤ºéƒ¨åˆ†å’Œçµ±è¨ˆè³‡æ–™
    const statText = `æº–å‰‡ ${critNow} / ${critTotal} é¡Œ  |  æ§‹é¢ ${dimNow} / ${dimTotal} é¡Œ  |  å®Œæˆåº¦ ${percent}%`;
    
    progressText.innerHTML = `<div style="text-align: center;"><span style="font-size: 0.95em;">${statText}</span></div>`;
  } else if (currentPhase === 'finish') {
    progressFill.style.width = '100%';
    progressText.textContent = 'å•å·å¡«å¯«å®Œæˆï¼';
  }
}

// è¼‰å…¥èªªæ˜é é¢
function loadIntroduction() {
  if (!surveyData || !surveyData['èªªæ˜']) {
    console.log('No introduction data found, using default content');
    return;
  }
  
  const intro = surveyData['èªªæ˜'];
  const titleElement = document.getElementById('introTitle');
  const contentElement = document.getElementById('introContent');
  const buttonElement = document.getElementById('introNextBtn');
  
  // è¨­å®šæ¨™é¡Œ
  if (titleElement) {
    titleElement.textContent = intro['æ¨™é¡Œ'] || 'DEMATELå•å·èª¿æŸ¥èªªæ˜';
  }
  
  // è¨­å®šå…§å®¹
  if (contentElement && intro['å…§å®¹']) {
    let htmlContent = '';
    intro['å…§å®¹'].forEach(line => {
      if (line.trim() === '') {
        htmlContent += '<br>';
      } else if (line.startsWith('å¡«å¯«èªªæ˜ï¼š') || line.startsWith('æœ¬å•å·åˆ†ç‚ºä¸‰å€‹éƒ¨åˆ†ï¼š')) {
        htmlContent += `<p><strong>${line}</strong></p>`;
      } else if (line.startsWith('â€¢') || line.startsWith('1.') || line.startsWith('2.') || line.startsWith('3.')) {
        htmlContent += `<p style="margin-left: 15px;">${line}</p>`;
      } else {
        htmlContent += `<p>${line}</p>`;
      }
    });
    contentElement.innerHTML = htmlContent;
  }
  
  // è¨­å®šæŒ‰éˆ•æ–‡å­—
  if (buttonElement && intro['æŒ‰éˆ•æ–‡å­—']) {
    buttonElement.textContent = intro['æŒ‰éˆ•æ–‡å­—'];
  }
}

// é¡¯ç¤ºåŸºæœ¬è³‡æ–™é é¢
function showBasicInfo() {
  // é˜²æ­¢å‹•ç•«æœŸé–“é‡è¤‡é»æ“Š
  if (isAnimating) return;
  
  currentPhase = 'basic';
  localStorage.setItem('dematel-phase', currentPhase);
  
  // ç¦ç”¨é é¢äº¤äº’
  disablePageInteraction();
  
  // æ·»åŠ å‹•ç•«æ¨£å¼
  addPageTransitionStyles();
  
  const introSection = document.getElementById('introSection');
  const basicInfoSection = document.getElementById('basicInfoSection');
  
  // æ¸…ç†å‹•ç•«é¡åˆ¥
  if (introSection) {
    introSection.classList.remove('page-transition-out', 'page-transition-in', 'page-transition-out-reverse', 'page-transition-in-reverse');
  }
  if (basicInfoSection) {
    basicInfoSection.classList.remove('page-transition-out', 'page-transition-in', 'page-transition-out-reverse', 'page-transition-in-reverse');
  }
  
  // ç¬¬ä¸€éšæ®µï¼šèªªæ˜é å‘å·¦æ»‘å‡º
  if (introSection) {
    introSection.classList.add('page-transition-out');
  }
  
  setTimeout(() => {
    // åˆ‡æ›é é¢é¡¯ç¤º
    document.getElementById('introSection').style.display = 'none';
    document.getElementById('basicInfoSection').style.display = 'block';
    document.getElementById('basicInfoSection').style.textAlign = 'center';
    
    loadBasicInfoForm();
    updateProgress();
    
    // æ¸…ç†èªªæ˜é å‹•ç•«
    if (introSection) {
      introSection.classList.remove('page-transition-out');
    }
    
    // ç¬¬äºŒéšæ®µï¼šåŸºæœ¬è³‡æ–™é å¾å³æ»‘å…¥
    if (basicInfoSection) {
      basicInfoSection.classList.add('page-transition-in');
      
      setTimeout(() => {
        // æ¸…ç†å‹•ç•«é¡åˆ¥
        basicInfoSection.classList.remove('page-transition-in');
        
        // å•Ÿç”¨é é¢äº¤äº’
        enablePageInteraction();
      }, 400);
    } else {
      // å¦‚æœæ²’æœ‰basicInfoSectionï¼Œä¹Ÿè¦å•Ÿç”¨äº¤äº’
      enablePageInteraction();
    }
  }, 400);
}

// è¼‰å…¥å’Œæ¸²æŸ“åŸºæœ¬è³‡æ–™è¡¨å–®
function loadBasicInfoForm() {
  if (!surveyData || !surveyData['åŸºæœ¬è³‡æ–™']) {
    console.error('No basic info structure found');
    return;
  }
  
  const basicFields = surveyData['åŸºæœ¬è³‡æ–™'];
  const form = document.getElementById('basicInfoForm');
  
  basicFields.forEach(field => {
    const group = document.createElement('div');
    group.className = 'form-group';
    
    const label = document.createElement('label');
    label.className = 'form-label' + (field.å¿…å¡« ? ' required' : '');
    label.textContent = field.åç¨±;
    group.appendChild(label);
    
    if (field.é¡å‹ === 'text') {
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'form-input';
      input.id = field.ç·¨è™Ÿ;
      input.placeholder = field.èªªæ˜ || '';
      input.value = basicInfo[field.ç·¨è™Ÿ] || '';
      input.addEventListener('input', () => {
        basicInfo[field.ç·¨è™Ÿ] = input.value;
        saveBasicInfoToLocal();
      });
      group.appendChild(input);
    } else if (field.é¡å‹ === 'select') {
      const select = document.createElement('select');
      select.className = 'form-select';
      select.id = field.ç·¨è™Ÿ;
      
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = 'è«‹é¸æ“‡...';
      select.appendChild(defaultOption);
      
      field.é¸é ….forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option;
        optionElement.textContent = option;
        select.appendChild(optionElement);
      });
      
      select.value = basicInfo[field.ç·¨è™Ÿ] || '';
      select.addEventListener('change', () => {
        basicInfo[field.ç·¨è™Ÿ] = select.value;
        saveBasicInfoToLocal();
      });
      group.appendChild(select);
    } else if (field.é¡å‹ === 'checkbox') {
      const checkboxGroup = document.createElement('div');
      checkboxGroup.className = 'checkbox-group';
      
      field.é¸é ….forEach(option => {
        const item = document.createElement('div');
        item.className = 'checkbox-item';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = field.ç·¨è™Ÿ + '_' + option;
        checkbox.value = option;
        
        const currentValues = basicInfo[field.ç·¨è™Ÿ] || [];
        checkbox.checked = currentValues.includes(option);
        
        checkbox.addEventListener('change', () => {
          if (!basicInfo[field.ç·¨è™Ÿ]) basicInfo[field.ç·¨è™Ÿ] = [];
          
          if (checkbox.checked) {
            if (!basicInfo[field.ç·¨è™Ÿ].includes(option)) {
              basicInfo[field.ç·¨è™Ÿ].push(option);
            }
          } else {
            basicInfo[field.ç·¨è™Ÿ] = basicInfo[field.ç·¨è™Ÿ].filter(item => item !== option);
          }
          saveBasicInfoToLocal();
        });
        
        const label = document.createElement('label');
        label.htmlFor = checkbox.id;
        label.textContent = option;
        
        item.appendChild(checkbox);
        item.appendChild(label);
        checkboxGroup.appendChild(item);
      });
      
      group.appendChild(checkboxGroup);
    }
    
    form.appendChild(group);
  });
}

// é©—è­‰åŸºæœ¬è³‡æ–™
function validateBasicInfo() {
  if (!surveyData || !surveyData['åŸºæœ¬è³‡æ–™']) {
    return true;
  }
  
  const basicFields = surveyData['åŸºæœ¬è³‡æ–™'];
  let isValid = true;
  
  basicFields.forEach(field => {
    if (field.å¿…å¡«) {
      const value = basicInfo[field.ç·¨è™Ÿ];
      const element = document.getElementById(field.ç·¨è™Ÿ);
      
      if (!value || (Array.isArray(value) && value.length === 0) || value.trim() === '') {
        if (element) {
          element.classList.add('error');
          element.addEventListener('input', () => element.classList.remove('error'), { once: true });
          element.addEventListener('change', () => element.classList.remove('error'), { once: true });
        }
        isValid = false;
      }
    }
  });
  
  if (!isValid) {
    alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
  }
  
  return isValid;
}

// é€²å…¥å•å·éšæ®µ
function proceedToSurvey() {
  // é˜²æ­¢å‹•ç•«æœŸé–“é‡è¤‡é»æ“Š
  if (isAnimating) return;
  
  if (!validateBasicInfo()) {
    return;
  }
  
  currentPhase = 'survey';
  localStorage.setItem('dematel-phase', currentPhase);
  
  // ç¦ç”¨é é¢äº¤äº’
  disablePageInteraction();
  
  // æ·»åŠ å‹•ç•«æ¨£å¼
  addPageTransitionStyles();
  
  const basicInfoSection = document.getElementById('basicInfoSection');
  const surveySection = document.getElementById('surveySection');
  
  // æ¸…ç†å‹•ç•«é¡åˆ¥
  if (basicInfoSection) {
    basicInfoSection.classList.remove('page-transition-out', 'page-transition-in', 'page-transition-out-reverse', 'page-transition-in-reverse');
  }
  if (surveySection) {
    surveySection.classList.remove('page-transition-out', 'page-transition-in', 'page-transition-out-reverse', 'page-transition-in-reverse');
  }
  
  // ç¬¬ä¸€éšæ®µï¼šåŸºæœ¬è³‡æ–™é å‘å·¦æ»‘å‡º
  if (basicInfoSection) {
    basicInfoSection.classList.add('page-transition-out');
  }
  
  setTimeout(() => {
    // åˆ‡æ›é é¢é¡¯ç¤º
    document.getElementById('basicInfoSection').style.display = 'none';
    document.getElementById('surveySection').style.display = 'block';
    
    loadSurveyQuestions();
    updateProgress();
    render();
    
    // æ¸…ç†åŸºæœ¬è³‡æ–™é å‹•ç•«
    if (basicInfoSection) {
      basicInfoSection.classList.remove('page-transition-out');
    }
    
    // ç¬¬äºŒéšæ®µï¼šå•å·é å¾å³æ»‘å…¥
    if (surveySection) {
      surveySection.classList.add('page-transition-in');
      
      setTimeout(() => {
        // æ¸…ç†å‹•ç•«é¡åˆ¥
        surveySection.classList.remove('page-transition-in');
        
        // å•Ÿç”¨é é¢äº¤äº’
        enablePageInteraction();
      }, 400);
    } else {
      // å¦‚æœæ²’æœ‰surveySectionï¼Œä¹Ÿè¦å•Ÿç”¨äº¤äº’
      enablePageInteraction();
    }
  }, 400);
}

// è¼‰å…¥å•å·é¡Œç›®
function loadSurveyQuestions(resetIndex = true) {
  if (!surveyData || !questions.length) return;
  
  // questions åœ¨ generateAllQuestions() ä¸­å·²ç¶“ç”Ÿæˆ
  // åªæœ‰åœ¨æ–°é–‹å§‹å•å·æ™‚æ‰é‡ç½® idx
  if (resetIndex) {
    idx = 0;
  }
  
  document.getElementById('introSection').style.display = 'none';
  document.getElementById('basicInfoSection').style.display = 'none';
  document.getElementById('surveySection').style.display = 'block';
  document.getElementById('finishSection').style.display = 'none';
  
  currentPhase = 'survey';
  saveToLocal();
  
  loadFromLocal();
  fillPrev();
  render();
}

// æ ¼å¼åŒ–åç¨±é¡¯ç¤º
function formatName(name) {
  const match = name.match(/^(.+?)\-(.+)$/);
  if (match) return `(${match[1]})${match[2]}`;
  return name;
}

// å¡«å…¥ä¹‹å‰çš„ç­”æ¡ˆ
function fillPrev() {
  if (idx >= questions.length) return;
  
  const q = questions[idx];
  const key = q.key;
  const prev = answers[key];
  
  if (!prev) { 
    rel = ''; 
    score1 = ''; 
    score2 = ''; 
    return; 
  }
  
  rel = prev.relation;
  if (rel === 'to') { 
    score1 = prev.score; 
    score2 = ''; 
  } else if (rel === 'from') { 
    score1 = ''; 
    score2 = prev.score; 
  } else if (rel === 'bi') { 
    score1 = prev.score_XtoY; 
    score2 = prev.score_YtoX; 
  } else { 
    score1 = ''; 
    score2 = ''; 
  }
}

// å„²å­˜åˆ°æœ¬åœ°å„²å­˜
function saveToLocal() {
  try {
    console.log('=== saveToLocal Debug ===');
    console.log('Saving answers:', answers);
    console.log('Saving currentPhase:', currentPhase);
    console.log('Saving idx:', idx);
    
    // æª¢æŸ¥ localStorage æ˜¯å¦å¯ç”¨
    if (typeof(Storage) === "undefined") {
      console.error('localStorage is not supported');
      alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´æœ¬åœ°å„²å­˜åŠŸèƒ½ï¼Œé€²åº¦å°‡ç„¡æ³•ä¿å­˜');
      return;
    }
    
    // æª¢æŸ¥ localStorage æ˜¯å¦è¢«ç¦ç”¨
    try {
      localStorage.setItem('test', 'test');
      localStorage.removeItem('test');
    } catch(e) {
      console.error('localStorage is disabled:', e);
      alert('æœ¬åœ°å„²å­˜åŠŸèƒ½è¢«ç¦ç”¨ï¼Œé€²åº¦å°‡ç„¡æ³•ä¿å­˜\nè«‹æª¢æŸ¥ç€è¦½å™¨éš±ç§è¨­ç½®');
      return;
    }
    
    // ä½¿ç”¨ JSON.stringify å‰å…ˆé©—è­‰æ•¸æ“š
    const answersString = JSON.stringify(answers);
    if (!answersString || answersString === 'null' || answersString === 'undefined') {
      console.error('Invalid answers data:', answers);
      return;
    }
    
    localStorage.setItem(LS_KEY, answersString);
    localStorage.setItem('dematel-phase', currentPhase);
    localStorage.setItem('dematel-idx', idx.toString());
    localStorage.setItem('dematel-last-save', new Date().toISOString());
    
    console.log('Successfully saved to localStorage');
    console.log('Verification - dematel_answers:', localStorage.getItem(LS_KEY));
    console.log('Verification - dematel-idx:', localStorage.getItem('dematel-idx'));
    console.log('Verification - dematel-phase:', localStorage.getItem('dematel-phase'));
    
    // é¡å¤–é©—è­‰ï¼šå˜—è©¦é‡æ–°è§£æä¿å­˜çš„æ•¸æ“š
    const verifyData = JSON.parse(localStorage.getItem(LS_KEY));
    console.log('Verification - parsed data:', verifyData);
    
  } catch(e) {
    console.error('Error saving to localStorage:', e);
    alert('ä¿å­˜é€²åº¦æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + e.message + '\næ‚¨çš„é€²åº¦å¯èƒ½ç„¡æ³•ä¿å­˜');
  }
}

function saveBasicInfoToLocal() {
  try {
    localStorage.setItem(LS_BASIC_KEY, JSON.stringify(basicInfo));
  } catch(e) {}
}

// å¾æœ¬åœ°å„²å­˜è¼‰å…¥
function loadFromLocal() {
  try {
    const data = localStorage.getItem(LS_KEY);
    if (data) {
      answers = JSON.parse(data);
    }
  } catch(e) {}
}

function loadBasicInfoFromLocal() {
  try {
    const data = localStorage.getItem(LS_BASIC_KEY);
    if (data) {
      basicInfo = JSON.parse(data);
    }
  } catch(e) {}
}

// æ¸²æŸ“å•å·é¡Œç›®
function render() {
  const el = document.getElementById('main');
  
  if (idx >= questions.length) {
    currentPhase = 'finish';
    
    // é˜²æ­¢å‹•ç•«æœŸé–“é‡è¤‡é»æ“Š
    if (isAnimating) return;
    
    // ç¦ç”¨é é¢äº¤äº’
    disablePageInteraction();
    
    // æ·»åŠ å‹•ç•«æ¨£å¼
    addPageTransitionStyles();
    
    const surveySection = document.getElementById('surveySection');
    const finishSection = document.getElementById('finishSection');
    
    // æ¸…ç†å‹•ç•«é¡åˆ¥
    if (surveySection) {
      surveySection.classList.remove('page-transition-out', 'page-transition-in', 'page-transition-out-reverse', 'page-transition-in-reverse');
    }
    if (finishSection) {
      finishSection.classList.remove('page-transition-out', 'page-transition-in', 'page-transition-out-reverse', 'page-transition-in-reverse');
    }
    
    // ç¬¬ä¸€éšæ®µï¼šå•å·é å‘å·¦æ»‘å‡º
    if (surveySection) {
      surveySection.classList.add('page-transition-out');
    }
    
    setTimeout(() => {
      // åˆ‡æ›é é¢é¡¯ç¤º
      document.getElementById('surveySection').style.display = 'none';
      document.getElementById('finishSection').style.display = 'block';
      updateProgress();
      
      // æ¸…ç†å•å·é å‹•ç•«
      if (surveySection) {
        surveySection.classList.remove('page-transition-out');
      }
      
      // ç¬¬äºŒéšæ®µï¼šå®Œæˆé å¾å³æ»‘å…¥
      if (finishSection) {
        finishSection.classList.add('page-transition-in');
        
        setTimeout(() => {
          // æ¸…ç†å‹•ç•«é¡åˆ¥
          finishSection.classList.remove('page-transition-in');
          
          // å•Ÿç”¨é é¢äº¤äº’
          enablePageInteraction();
        }, 400);
      }
    }, 400);
    
    return;
  }
  
  const q = questions[idx];
  let phaseLabel = q.type === 'criteria' ? 'ç¬¬äºŒéƒ¨åˆ†ï¼šæº–å‰‡æ¯”è¼ƒ' : 'ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ§‹é¢æ¯”è¼ƒ';
  let phaseColor = q.type === 'criteria' ? '#2a5298' : '#58aa5a';
  let nameA = q.A.name, nameB = q.B.name;
  let descA = q.A.desc || '', descB = q.B.desc || '';
  
  // è¨ˆç®—ç•¶å‰é¡Œè™Ÿé¡¯ç¤º (idx æ˜¯ç´¢å¼•ï¼Œå¾0é–‹å§‹ï¼Œæ‰€ä»¥é¡Œè™Ÿè¦+1)
  let currentQuestionNumber = idx + 1;
  let critNow = 0;
  let dimNow = 0;
  
  if (q.type === 'criteria') {
    // æº–å‰‡é¡Œç›®ï¼šæ‰¾å‡ºç•¶å‰æ˜¯ç¬¬å¹¾é¡Œæº–å‰‡
    critNow = questions.slice(0, idx + 1).filter(qq => qq.type === 'criteria').length;
  } else {
    // æ§‹é¢é¡Œç›®ï¼šæ‰¾å‡ºç•¶å‰æ˜¯ç¬¬å¹¾é¡Œæ§‹é¢
    critNow = critTotal; // æº–å‰‡å·²ç¶“å…¨éƒ¨å®Œæˆ
    dimNow = questions.slice(0, idx + 1).filter(qq => qq.type === 'dimension').length;
  }
  
  let critText = `æº–å‰‡ ${critNow} / ${critTotal} é¡Œ`;
  let dimText = `æ§‹é¢ ${dimNow} / ${dimTotal} é¡Œ`;
  let percent = Math.floor((idx / questions.length) * 100);
  
  el.innerHTML = `
    <div class="form-title">${phaseLabel}</div>
    <div class="intro-content" style="background: #fff9f9; border-left: 4px solid #d4a373;">
      <div class="step-title">${q.type === 'criteria' ? 'è«‹åˆ¤æ–·ä¸‹åˆ—æº–å‰‡äº’ç›¸ä¹‹é–“çš„é—œä¿‚' : 'è«‹åˆ¤æ–·ä¸‹åˆ—æ§‹é¢äº’ç›¸ä¹‹é–“çš„é—œä¿‚'}</div>
      <div class="desc-row">
        <div class="desc-block">
          <div class="block-title">${formatName(nameA)}</div>
          <div class="desc-content">${descA.replace(/\n/g,'<br>')}</div>
        </div>
        <div class="block-vs">vs.</div>
        <div class="desc-block">
          <div class="block-title">${formatName(nameB)}</div>
          <div class="desc-content">${descB.replace(/\n/g,'<br>')}</div>
        </div>
      </div>
      <div class="relation-group relation-buttons">
        <button class="btn${rel==='X'?' selected':''}" type="button" onclick="chooseRel('X')">å…©è€…ç„¡é—œ</button>
        <button class="btn${rel==='to'?' selected':''}" type="button" onclick="chooseRel('to')">${formatName(nameA)} å½±éŸ¿ ${formatName(nameB)}</button>
        <button class="btn${rel==='from'?' selected':''}" type="button" onclick="chooseRel('from')">${formatName(nameB)} å½±éŸ¿ ${formatName(nameA)}</button>
        <button class="btn${rel==='bi'?' selected':''}" type="button" onclick="chooseRel('bi')">å…©è€…äº’ç›¸å½±éŸ¿</button>
      </div>
      <div class="control-buttons">
        ${idx > 0 ? `<button class="control-btn prev-btn" onclick="prevStep()">â† ä¸Šä¸€é¡Œ</button>` : ""}
        <button class="control-btn next-btn" id="nextBtn" style="display:none;" onclick="saveStep()">ä¸‹ä¸€é¡Œ â†’</button>
      </div>
    </div>
  `;
  
  renderScore();
  updateProgress();
}

// é¡¯ç¤ºæ“ä½œæç¤º
function showActionNotification(message, type = 'info', duration = 2000) {
  // ç§»é™¤ç¾æœ‰æç¤º
  const existingNotif = document.querySelector('.action-notification');
  if (existingNotif) {
    existingNotif.remove();
  }
  
  const notification = document.createElement('div');
  notification.className = 'action-notification';
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: ${type === 'success' ? '#ccd5ae' : 
                 type === 'warning' ? '#d4a373' : 
                 '#e9edc9'};
    color: #333;
    padding: 12px 20px;
    border-radius: 25px;
    font-weight: 500;
    z-index: 1000;
    animation: slideInDown 0.3s ease;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    border: 2px solid ${type === 'success' ? '#d4a373' : 
                       type === 'warning' ? '#ccd5ae' : 
                       '#ccd5ae'};
  `;
  notification.textContent = message;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'slideOutUp 0.3s ease';
    setTimeout(() => notification.remove(), 300);
  }, duration);
}

// æ·»åŠ ç¿»é å‹•ç•«æ¨£å¼
function addPageTransitionStyles() {
  if (document.querySelector('#pageTransitionStyles')) return;
  
  const style = document.createElement('style');
  style.id = 'pageTransitionStyles';
  style.textContent = `
    @keyframes slideInDown {
      from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
    @keyframes slideOutUp {
      from { transform: translateX(-50%) translateY(0); opacity: 1; }
      to { transform: translateX(-50%) translateY(-100%); opacity: 0; }
    }
    
    @keyframes pageFlipOut {
      0% { transform: rotateY(0deg); opacity: 1; }
      50% { transform: rotateY(-90deg); opacity: 0.5; }
      100% { transform: rotateY(-180deg); opacity: 0; }
    }
    
    @keyframes pageFlipIn {
      0% { transform: rotateY(180deg); opacity: 0; }
      50% { transform: rotateY(90deg); opacity: 0.5; }
      100% { transform: rotateY(0deg); opacity: 1; }
    }
    
    @keyframes slideOutLeft {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(-100%); opacity: 0; }
    }
    
    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOutRight {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
    
    @keyframes slideInLeft {
      from { transform: translateX(-100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .page-transition-out {
      animation: slideOutLeft 0.4s ease-in-out forwards;
    }
    
    .page-transition-in {
      animation: slideInRight 0.4s ease-in-out forwards;
      transform: translateX(100%);
      opacity: 0;
    }
    
    .page-transition-out-reverse {
      animation: slideOutRight 0.4s ease-in-out forwards;
    }
    
    .page-transition-in-reverse {
      animation: slideInLeft 0.4s ease-in-out forwards;
      transform: translateX(-100%);
      opacity: 0;
    }
    
    /* ç¢ºä¿å‹•ç•«å…ƒç´ æœ‰æ­£ç¢ºçš„åˆå§‹ç‹€æ…‹ */
    #main {
      transform: translateX(0);
      opacity: 1;
      transition: none;
    }
    
    /* å‹•ç•«æœŸé–“çš„ç¦ç”¨è¦†è“‹å±¤ */
    .animation-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.1);
      z-index: 9999;
      cursor: wait;
      display: none;
    }
    
    /* ç¦ç”¨æŒ‰éˆ•æ¨£å¼ */
    .btn:disabled, .control-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      pointer-events: none;
    }
    
    .flip-transition-out {
      animation: pageFlipOut 0.5s ease-in-out;
      transform-style: preserve-3d;
    }
    
    .flip-transition-in {
      animation: pageFlipIn 0.5s ease-in-out;
      transform-style: preserve-3d;
    }
  `;
  document.head.appendChild(style);
}

// é¸æ“‡é—œä¿‚
function chooseRel(v) {
  rel = v;          // ç«‹å³è¨˜éŒ„é¸é …
  score1 = '';      // æ¸…ç©ºä¹‹å‰çš„åˆ†æ•¸
  score2 = '';
  render();         // æŒ‰éˆ•ç«‹å³äº®èµ·

  console.log('=== chooseRel Debug ===');
  console.log('Selected relation:', v);
  console.log('Current question idx:', idx);
  console.log('rel variable set to:', rel);

  if (v === 'X') {              // å…©è€…ç„¡é—œï¼šä¸éœ€åˆ†æ•¸
    // ç«‹å³ä¿å­˜ç­”æ¡ˆ
    const q = questions[idx];
    const key = q.key;
    answers[key] = { relation: 'X' };
    console.log('Immediately saved "X" answer for question', idx + 1, ':', answers[key]);
    
    closeScoreModal({ keepSelection: true }); // ç¢ºä¿modalé—œé–‰ä½†ä¿ç•™é¸ä¸­ç‹€æ…‹
    goNextPage();      // ç›´æ¥ç¿»é 
  } else {                      // å…¶ä»–é¸é …ï¼šå…ˆé¸åˆ†æ•¸
    showScoreModal();           // ä¿ç•™æ—¢æœ‰å½ˆçª—æµç¨‹
  }
}

// é¡¯ç¤ºåˆ†æ•¸é¸æ“‡æ‡¸æµ®è¦–çª—
function showScoreModal() {
  let modal = document.getElementById('scoreModal');
  if (!modal) {
    modal = createScoreModal();
  }
  
  updateScoreModalContent();
  modal.style.display = 'flex';
  
  // æ·»åŠ é¡¯ç¤ºå‹•ç•«
  setTimeout(() => {
    modal.classList.add('modal-show');
  }, 10);
}

// é—œé–‰åˆ†æ•¸é¸æ“‡æ‡¸æµ®è¦–çª—
function closeScoreModal(opts = {}) {
  const modal = document.getElementById('scoreModal');
  if (modal) {
    modal.classList.remove('modal-show');
    setTimeout(() => {
      modal.style.display = 'none';
    }, 300);
  }
  
  // åªæœ‰åœ¨æ²’æœ‰è¦æ±‚ä¿ç•™é¸ä¸­ç‹€æ…‹æ™‚æ‰æ¸…é™¤
  if (!opts.keepSelection) {
    rel = '';
    score1 = '';
    score2 = '';
  }
  
  // é‡æ–°æ¸²æŸ“é é¢ï¼Œæ›´æ–°æŒ‰éˆ•ç‹€æ…‹
  render();
}

// å»¶é²æ¸…é™¤é¸ä¸­ç‹€æ…‹ï¼ˆè®“ç”¨æˆ¶èƒ½çœ‹åˆ°é¸æ“‡çµæœï¼‰
// å»¶é²æ¸…é™¤é¸ä¸­ç‹€æ…‹çš„è®Šæ•¸
let clearSelectionTimer = null;

function clearSelectionDelayed(delay = 200) {
  // æ¸…é™¤ä¹‹å‰çš„è¨ˆæ™‚å™¨
  if (clearSelectionTimer) {
    clearTimeout(clearSelectionTimer);
    clearSelectionTimer = null;
  }
  
  // è¨­ç½®æ–°çš„å»¶é²æ¸…é™¤
  clearSelectionTimer = setTimeout(() => {
    // æ¸…é™¤ç•¶å‰é¸æ“‡çš„é—œä¿‚å’Œåˆ†æ•¸
    rel = '';
    score1 = '';
    score2 = '';
    
    // é‡æ–°æ¸²æŸ“é é¢ï¼Œæ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    render();
    
    clearSelectionTimer = null;
  }, delay);
}

// ç«‹å³æ¸…é™¤é¸ä¸­ç‹€æ…‹ä¸¦å–æ¶ˆå»¶é²
function clearSelectionImmediate() {
  // å–æ¶ˆå»¶é²æ¸…é™¤
  if (clearSelectionTimer) {
    clearTimeout(clearSelectionTimer);
    clearSelectionTimer = null;
  }
  
  // ç«‹å³æ¸…é™¤
  rel = '';
  score1 = '';
  score2 = '';
}

// å‰µå»ºæ‡¸æµ®è¦–çª—
function createScoreModal() {
  const modal = document.createElement('div');
  modal.id = 'scoreModal';
  modal.className = 'score-modal';
  
  modal.innerHTML = `
    <div class="modal-overlay" onclick="closeScoreModal()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">é¸æ“‡å½±éŸ¿ç¨‹åº¦</h3>
        <button class="modal-close" onclick="closeScoreModal()">&times;</button>
      </div>
      <div class="modal-body" id="modalScoreContent">
        <!-- åˆ†æ•¸é¸æ“‡å…§å®¹å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  return modal;
}

// æ›´æ–°æ‡¸æµ®è¦–çª—å…§å®¹
function updateScoreModalContent() {
  const content = document.getElementById('modalScoreContent');
  if (!content) return;
  
  if (rel === '' || rel === 'X') {
    content.innerHTML = '';
    return;
  }
  
  const q = questions[idx];
  let html = '';
  
  if (rel === 'to') {
    html = `
      <div class="modal-relation-info">
        <strong>${formatName(q.A.name)}</strong> å½±éŸ¿ <strong>${formatName(q.B.name)}</strong>
      </div>
      <div class="modal-score-title">è«‹é¸æ“‡å½±éŸ¿ç¨‹åº¦ (1=ä½å½±éŸ¿, 4=é«˜å½±éŸ¿)</div>
      <div class="modal-score-group">
        <button class="modal-score-btn${score1==='1'?' selected':''}" onclick="chooseScoreInModal(1, '1')">1</button>
        <button class="modal-score-btn${score1==='2'?' selected':''}" onclick="chooseScoreInModal(1, '2')">2</button>
        <button class="modal-score-btn${score1==='3'?' selected':''}" onclick="chooseScoreInModal(1, '3')">3</button>
        <button class="modal-score-btn${score1==='4'?' selected':''}" onclick="chooseScoreInModal(1, '4')">4</button>
      </div>
    `;
  } else if (rel === 'from') {
    html = `
      <div class="modal-relation-info">
        <strong>${formatName(q.B.name)}</strong> å½±éŸ¿ <strong>${formatName(q.A.name)}</strong>
      </div>
      <div class="modal-score-title">è«‹é¸æ“‡å½±éŸ¿ç¨‹åº¦ (1=ä½å½±éŸ¿, 4=é«˜å½±éŸ¿)</div>
      <div class="modal-score-group">
        <button class="modal-score-btn${score2==='1'?' selected':''}" onclick="chooseScoreInModal(2, '1')">1</button>
        <button class="modal-score-btn${score2==='2'?' selected':''}" onclick="chooseScoreInModal(2, '2')">2</button>
        <button class="modal-score-btn${score2==='3'?' selected':''}" onclick="chooseScoreInModal(2, '3')">3</button>
        <button class="modal-score-btn${score2==='4'?' selected':''}" onclick="chooseScoreInModal(2, '4')">4</button>
      </div>
    `;
  } else if (rel === 'bi') {
    html = `
      <div class="modal-relation-info">
        <strong>å…©è€…äº’ç›¸å½±éŸ¿</strong>
      </div>
      <div class="modal-score-section">
        <div class="modal-score-title">${formatName(q.A.name)} â†’ ${formatName(q.B.name)} çš„å½±éŸ¿ç¨‹åº¦</div>
        <div class="modal-score-group">
          <button class="modal-score-btn${score1==='1'?' selected':''}" onclick="chooseScoreInModal(1, '1')">1</button>
          <button class="modal-score-btn${score1==='2'?' selected':''}" onclick="chooseScoreInModal(1, '2')">2</button>
          <button class="modal-score-btn${score1==='3'?' selected':''}" onclick="chooseScoreInModal(1, '3')">3</button>
          <button class="modal-score-btn${score1==='4'?' selected':''}" onclick="chooseScoreInModal(1, '4')">4</button>
        </div>
      </div>
      <div class="modal-score-section">
        <div class="modal-score-title">${formatName(q.B.name)} â†’ ${formatName(q.A.name)} çš„å½±éŸ¿ç¨‹åº¦</div>
        <div class="modal-score-group">
          <button class="modal-score-btn${score2==='1'?' selected':''}" onclick="chooseScoreInModal(2, '1')">1</button>
          <button class="modal-score-btn${score2==='2'?' selected':''}" onclick="chooseScoreInModal(2, '2')">2</button>
          <button class="modal-score-btn${score2==='3'?' selected':''}" onclick="chooseScoreInModal(2, '3')">3</button>
          <button class="modal-score-btn${score2==='4'?' selected':''}" onclick="chooseScoreInModal(2, '4')">4</button>
        </div>
      </div>
    `;
  }
  
  content.innerHTML = html;
}

// åœ¨æ‡¸æµ®è¦–çª—ä¸­é¸æ“‡åˆ†æ•¸
function chooseScoreInModal(idxN, v) {
  if (idxN === 1) score1 = v;
  if (idxN === 2) score2 = v;
  
  console.log('=== chooseScoreInModal Debug ===');
  console.log('Selected score for index', idxN, ':', v);
  console.log('Current scores - score1:', score1, 'score2:', score2);
  
  updateScoreModalContent(); // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
  render(); // æ›´æ–°ä¸»é é¢
  
  const q = questions[idx];
  
  // æª¢æŸ¥æ˜¯å¦å®Œæˆæ­¤é¡Œ
  let isComplete = false;
  if (rel === 'to' && score1) {
    isComplete = true;
  } else if (rel === 'from' && score2) {
    isComplete = true;
  } else if (rel === 'bi' && score1 && score2) {
    isComplete = true;
  }
  
  console.log('Question complete status:', isComplete);
  
  // å¦‚æœå®Œæˆï¼Œå…ˆä¿å­˜ç•¶å‰ç­”æ¡ˆï¼Œæ›´æ–°idxï¼Œç„¶å¾Œè‡ªå‹•é—œé–‰æ‡¸æµ®è¦–çª—ä¸¦è·³é¡Œ
  if (isComplete) {
    // ä¿å­˜ç­”æ¡ˆ
    const key = q.key;
    if (rel === 'to') {
      answers[key] = { relation: 'to', score: score1 };
    } else if (rel === 'from') {
      answers[key] = { relation: 'from', score: score2 };
    } else if (rel === 'bi') {
      answers[key] = { relation: 'bi', score_XtoY: score1, score_YtoX: score2 };
    }
    
    console.log('Completed answer for question', idx + 1, ':', answers[key]);
    
    setTimeout(() => {
      // é—œé–‰è¦–çª—ä½†ä¿ç•™é¸ä¸­ç‹€æ…‹
      closeScoreModal({ keepSelection: true });
      
      setTimeout(() => {
        // ä½¿ç”¨çµ±ä¸€çš„ç¿»é å‡½æ•¸
        goNextPage();
      }, 300);
    }, 500); // è®“ä½¿ç”¨è€…çœ‹åˆ°é¸æ“‡çµæœ
  }
}

// æ¸²æŸ“åˆ†æ•¸é¸æ“‡ï¼ˆç¾åœ¨ä¸»è¦ç”¨æ–¼æ›´æ–°æŒ‰éˆ•ç‹€æ…‹ï¼‰
function renderScore() {
  // é¡¯ç¤ºä¸‹ä¸€é¡ŒæŒ‰éˆ•
  const nextBtn = document.getElementById('nextBtn');
  if (nextBtn) {
    if (rel === 'X' || 
       (rel === 'to' && score1) || 
       (rel === 'from' && score2) || 
       (rel === 'bi' && score1 && score2)) {
      nextBtn.style.display = 'inline-block';
    } else {
      nextBtn.style.display = 'none';
    }
  }
}

// çµ±ä¸€çš„ç¿»é å‡½æ•¸
function goNextPage() {
  // æ›´æ–° idx ä¸¦ä¿å­˜
  idx++;
  console.log('Updated idx to:', idx, '(å·²å®Œæˆ', idx, 'é¡Œ)');
  saveToLocal(); // ä¿å­˜æ›´æ–°å¾Œçš„ç‹€æ…‹
  
  // å•Ÿå‹•ç¿»é å‹•ç•«
  executePageTransition();
  
  // å»¶é²æ¸…é™¤é¸ä¸­ç‹€æ…‹ï¼ˆåœ¨å‹•ç•«åˆ‡æ›å…§å®¹ä¹‹å‰ï¼‰
  clearSelectionDelayed(350); // åœ¨ fillPrev() è¢«èª¿ç”¨å‰æ¸…é™¤
}

// åŸ·è¡Œé é¢åˆ‡æ›å‹•ç•«
function executePageTransition() {
  const mainElement = document.getElementById('main');
  if (!mainElement) {
    // å¦‚æœæ²’æœ‰mainå…ƒç´ ï¼Œç›´æ¥åŸ·è¡Œç„¡å‹•ç•«ç‰ˆæœ¬
    fillPrev();
    render();
    return;
  }
  
  // ç¦ç”¨é é¢äº¤äº’
  disablePageInteraction();
  
  // æ·»åŠ å‹•ç•«æ¨£å¼
  addPageTransitionStyles();
  
  // æ¸…ç†ä¹‹å‰çš„å‹•ç•«é¡åˆ¥
  mainElement.classList.remove('page-transition-out', 'page-transition-in', 'page-transition-out-reverse', 'page-transition-in-reverse');
  
  // é‡ç½®å…ƒç´ ç‹€æ…‹
  mainElement.style.transform = 'translateX(0)';
  mainElement.style.opacity = '1';
  
  // çŸ­æš«å»¶é²ç¢ºä¿æ¸…ç†å®Œæˆ
  setTimeout(() => {
    // ç¬¬ä¸€éšæ®µï¼šå‘å·¦æ»‘å‡ºå‹•ç•«ï¼ˆç•¶å‰é¡Œç›®é›¢é–‹ï¼‰
    mainElement.classList.add('page-transition-out');
    
    setTimeout(() => {
      // åœ¨å‹•ç•«ä¸­é–“åˆ‡æ›åˆ°ä¸‹ä¸€é¡Œï¼ˆé€™æ™‚ idx å·²ç¶“æ˜¯æ–°çš„å€¼ï¼‰
      // å…ˆè¼‰å…¥æ–°é¡Œç›®çš„å…§å®¹ï¼Œä½†æš«æ™‚ä¸æ¸…é™¤é¸ä¸­ç‹€æ…‹
      fillPrev(); // æ ¹æ“šç•¶å‰ idx è¼‰å…¥å°æ‡‰çš„ç­”æ¡ˆ
      render();   // æ¸²æŸ“æ–°çš„é¡Œç›®
      
      // ç§»é™¤å‡ºå»å‹•ç•«ï¼Œæº–å‚™é€²å…¥å‹•ç•«
      mainElement.classList.remove('page-transition-out');
      
      // ç¬¬äºŒéšæ®µï¼šå¾å³æ»‘å…¥å‹•ç•«ï¼ˆä¸‹ä¸€é¡Œé€²å…¥ï¼‰
      mainElement.classList.add('page-transition-in');
      
      setTimeout(() => {
        // æ¸…ç†å‹•ç•«é¡åˆ¥ä¸¦é‡ç½®ç‹€æ…‹
        mainElement.classList.remove('page-transition-in');
        mainElement.style.transform = 'translateX(0)';
        mainElement.style.opacity = '1';
        
        // å•Ÿç”¨é é¢äº¤äº’
        enablePageInteraction();
      }, 400);
    }, 400);
  }, 50);
}

// å„²å­˜ç­”æ¡ˆä¸¦é€²å…¥ä¸‹ä¸€é¡Œ
function saveStep() {
  // é˜²æ­¢å‹•ç•«æœŸé–“é‡è¤‡é»æ“Š
  if (isAnimating) return;
  
  const q = questions[idx];
  const key = q.key;
  
  console.log('=== saveStep Debug ===');
  console.log('Current idx:', idx, '(æ­£åœ¨å›ç­”ç¬¬', idx + 1, 'é¡Œ)');
  console.log('Current question:', q);
  console.log('Answer key:', key);
  console.log('rel:', rel, 'score1:', score1, 'score2:', score2);
  
  // ä¿å­˜ç­”æ¡ˆ
  if (rel === 'X') {
    answers[key] = { relation: 'X' };
  } else if (rel === 'to') {
    answers[key] = { relation: 'to', score: score1 };
  } else if (rel === 'from') {
    answers[key] = { relation: 'from', score: score2 };
  } else if (rel === 'bi') {
    answers[key] = { relation: 'bi', score_XtoY: score1, score_YtoX: score2 };
  }
  
  console.log('Saved answer for question', idx + 1, ':', answers[key]);
  console.log('Total answered questions after saving:', Object.keys(answers).length);
  
  // å…ˆæ›´æ–° idxï¼Œç„¶å¾Œä¿å­˜åˆ° localStorage
  idx++;
  console.log('New idx after increment:', idx, '(å·²å®Œæˆ', idx, 'é¡Œï¼Œå°‡é¡¯ç¤ºç¬¬', idx + 1, 'é¡Œ)');
  
  saveToLocal();
  
  // ç«‹å³é–‹å§‹é é¢åˆ‡æ›å‹•ç•«
  executePageTransition();
}

// ä¸Šä¸€é¡Œ
function prevStep() {
  if (idx <= 0) return;
  
  // é˜²æ­¢å‹•ç•«æœŸé–“é‡è¤‡é»æ“Š
  if (isAnimating) return;
  
  const mainElement = document.getElementById('main');
  if (!mainElement) {
    idx--;
    fillPrev();
    render();
    return;
  }
  
  // ç¦ç”¨é é¢äº¤äº’
  disablePageInteraction();
  
  // æ·»åŠ å‹•ç•«æ¨£å¼
  addPageTransitionStyles();
  
  // æ¸…ç†ä¹‹å‰çš„å‹•ç•«é¡åˆ¥
  mainElement.classList.remove('page-transition-out', 'page-transition-in', 'page-transition-out-reverse', 'page-transition-in-reverse');
  
  // é‡ç½®å…ƒç´ ç‹€æ…‹
  mainElement.style.transform = 'translateX(0)';
  mainElement.style.opacity = '1';
  
  // çŸ­æš«å»¶é²ç¢ºä¿æ¸…ç†å®Œæˆ
  setTimeout(() => {
    // ç¬¬ä¸€éšæ®µï¼šå‘å³æ»‘å‡ºå‹•ç•«
    mainElement.classList.add('page-transition-out-reverse');
    
    setTimeout(() => {
      // åŸ·è¡Œå¯¦éš›çš„é¡Œç›®åˆ‡æ›
      idx--;
      fillPrev();
      render();
      
      // ç§»é™¤å‡ºå»å‹•ç•«ï¼Œæº–å‚™é€²å…¥å‹•ç•«
      mainElement.classList.remove('page-transition-out-reverse');
      
      // ç¬¬äºŒéšæ®µï¼šå¾å·¦æ»‘å…¥å‹•ç•«
      mainElement.classList.add('page-transition-in-reverse');
      
      setTimeout(() => {
        // æ¸…ç†å‹•ç•«é¡åˆ¥ä¸¦é‡ç½®ç‹€æ…‹
        mainElement.classList.remove('page-transition-in-reverse');
        mainElement.style.transform = 'translateX(0)';
        mainElement.style.opacity = '1';
        
        // å•Ÿç”¨é é¢äº¤äº’
        enablePageInteraction();
      }, 400);
    }, 400);
  }, 50);
}

// è¼‰å…¥JSONçµæ§‹
function loadJSON(name) {
  // å¼·åˆ¶é‡æ–°ä¸‹è¼‰ï¼Œç¦æ­¢å¿«å–
  const cacheBuster = '?t=' + Date.now();
  fetch(name + cacheBuster, {
    cache: 'no-cache',
    headers: {
      'Cache-Control': 'no-cache',
      'Pragma': 'no-cache'
    }
  })
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
      surveyData = data;
      
      // ç”Ÿæˆæ‰€æœ‰é¡Œç›®
      generateAllQuestions(data);
      
      // è¨ˆç®—è³‡æ–™çš„ MD5 hash
      const currentDataHash = calculateMD5(JSON.stringify(data));
      const savedDataHash = localStorage.getItem('dematel-data-hash');
      
      if (savedDataHash && savedDataHash !== currentDataHash) {
        // JSONè³‡æ–™å·²è®ŠåŒ–ï¼Œå¼·åˆ¶é‡å¡«
        alert('æª¢æ¸¬åˆ°å•å·è³‡æ–™å·²æ›´æ–°ï¼Œéœ€è¦é‡æ–°å¡«å¯«ã€‚å°‡æ¸…é™¤ä¹‹å‰çš„è³‡æ–™ã€‚');
        clearAllData();
        try {
          localStorage.setItem('dematel-data-hash', currentDataHash);
          console.log('Updated data hash after clearing:', currentDataHash);
        } catch(e) {
          console.error('Failed to save data hash:', e);
        }
        initializePage();
      } else if (savedDataHash === currentDataHash) {
        // è³‡æ–™ç›¸åŒï¼Œè©¢å•æ˜¯å¦ç¹¼çºŒ
        try {
          localStorage.setItem('dematel-data-hash', currentDataHash);
          console.log('Confirmed data hash:', currentDataHash);
        } catch(e) {
          console.error('Failed to save data hash:', e);
        }
        checkAndRestoreProgress();
      } else {
        // ç¬¬ä¸€æ¬¡è¼‰å…¥ï¼Œæ²’æœ‰å„²å­˜çš„ hash
        try {
          localStorage.setItem('dematel-data-hash', currentDataHash);
          console.log('First time - saved data hash:', currentDataHash);
        } catch(e) {
          console.error('Failed to save data hash on first load:', e);
        }
        initializePage();
      }
    })
    .catch(error => {
      console.error('Error loading JSON:', error);
      alert('è¼‰å…¥å•å·çµæ§‹å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
    });
}

// ç”Ÿæˆæ‰€æœ‰é¡Œç›®
function generateAllQuestions(data) {
  questions = [];
  let questionIndex = 0;
  
  // æå–æ§‹é¢å’Œæº–å‰‡æ•¸æ“š
  const dimensions = data['æ¶æ§‹'];
  
  let items = [];
  dimensions.forEach(dim => {
    if (dim.æº–å‰‡ && dim.æº–å‰‡.length > 0) {
      dim.æº–å‰‡.forEach(rule => {
        items.push({ 
          id: rule.ç·¨è™Ÿ, 
          name: `${dim.æ§‹é¢}-${rule.åç¨±}`, 
          desc: rule.èªªæ˜ || rule.å…§å®¹ || '' 
        });
      });
    }
  });
  
  // ç”Ÿæˆæº–å‰‡æ¯”è¼ƒé¡Œç›®
  for (let i = 0; i < items.length; i++) {
    for (let j = i + 1; j < items.length; j++) {
      questions.push({
        index: questionIndex,
        key: `${items[i].id}->${items[j].id}`,
        type: 'criteria',
        A: items[i],
        B: items[j]
      });
      questionIndex++;
    }
  }
  
  critTotal = questionIndex;
  
  // ç”Ÿæˆæ§‹é¢æ¯”è¼ƒé¡Œç›®
  let dims = dimensions.map(dim => ({ 
    id: dim.æ§‹é¢, 
    name: dim.æ§‹é¢, 
    desc: dim.èªªæ˜ || '' 
  }));
  
  for (let i = 0; i < dims.length; i++) {
    for (let j = i + 1; j < dims.length; j++) {
      questions.push({
        index: questionIndex,
        key: `${dims[i].id}->${dims[j].id}`,
        type: 'dimension',
        A: dims[i],
        B: dims[j]
      });
      questionIndex++;
    }
  }
  
  dimTotal = questionIndex - critTotal;
}

// åˆå§‹åŒ–é é¢
function initializePage() {
  // é¡¯ç¤ºä»‹ç´¹é é¢ï¼Œéš±è—å…¶ä»–é é¢
  document.getElementById('introSection').style.display = 'block';
  document.getElementById('basicInfoSection').style.display = 'none';
  document.getElementById('surveySection').style.display = 'none';
  document.getElementById('finishSection').style.display = 'none';
  
  loadBasicInfoFromLocal();
  loadIntroduction();
  updateProgress();
}

// ç°¡å–®çš„ MD5 è¨ˆç®—å‡½æ•¸
function calculateMD5(str) {
  // ç°¡åŒ–ç‰ˆ MD5ï¼Œå¯¦éš›ä¸Šä½¿ç”¨ cyrb53 hash
  let h1 = 1779033703, h2 = 3144134277, h3 = 1013904242, h4 = 2773480762;
  for (let i = 0, k; i < str.length; i++) {
    k = str.charCodeAt(i);
    h1 = h2 ^ Math.imul(h1 ^ k, 597399067);
    h2 = h3 ^ Math.imul(h2 ^ k, 2869860233);
    h3 = h4 ^ Math.imul(h3 ^ k, 951274213);
    h4 = h1 ^ Math.imul(h4 ^ k, 2716044179);
  }
  h1 = Math.imul(h3 ^ (h1 >>> 18), 597399067);
  h2 = Math.imul(h4 ^ (h2 >>> 22), 2869860233);
  h3 = Math.imul(h1 ^ (h3 >>> 17), 951274213);
  h4 = Math.imul(h2 ^ (h4 >>> 19), 2716044179);
  return [(h1^h2^h3^h4)>>>0, (h2^h1)>>>0, (h3^h1)>>>0, (h4^h1)>>>0].map(x => x.toString(16).padStart(8, '0')).join('');
}

// æª¢æŸ¥ä¸¦æ¢å¾©é€²åº¦æˆ–è©¢å•ç”¨æˆ¶
function checkAndRestoreProgress() {
  const savedAnswers = localStorage.getItem(LS_KEY);
  const savedPhase = localStorage.getItem('dematel-phase');
  const savedBasicInfo = localStorage.getItem(LS_BASIC_KEY);
  
  // æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•å„²å­˜çš„è³‡æ–™
  const hasData = savedAnswers || savedPhase || savedBasicInfo;
  
  if (hasData) {
    // æœ‰å„²å­˜çš„è³‡æ–™ï¼Œè©¢å•ç”¨æˆ¶æ˜¯å¦è¦ç¹¼çºŒ
    const userChoice = confirm('æª¢æ¸¬åˆ°æ‚¨ä¹‹å‰æœ‰å¡«å¯«éçš„è³‡æ–™ã€‚\n\né»æ“Šã€Œç¢ºå®šã€ç¹¼çºŒä¸Šæ¬¡çš„é€²åº¦\né»æ“Šã€Œå–æ¶ˆã€æ¸…é™¤è³‡æ–™é‡æ–°é–‹å§‹');
    
    if (userChoice) {
      // ç”¨æˆ¶é¸æ“‡ç¹¼çºŒï¼Œæ¢å¾©é€²åº¦
      restoreProgress();
    } else {
      // ç”¨æˆ¶é¸æ“‡é‡æ–°é–‹å§‹ï¼Œæ¸…é™¤æ‰€æœ‰è³‡æ–™
      clearAllData();
    }
  } else {
    // å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œåˆå§‹åŒ–é é¢
    initializePage();
  }
}

// æ¸…é™¤æ‰€æœ‰å„²å­˜çš„è³‡æ–™
function clearAllData() {
  localStorage.removeItem(LS_KEY);  // 'dematel_answers'
  localStorage.removeItem(LS_BASIC_KEY);  // 'dematel_basic_info'
  localStorage.removeItem('dematel-phase');
  localStorage.removeItem('dematel-idx');
  localStorage.removeItem('dematel-data-hash');
  
  // é‡ç½®è®Šæ•¸
  answers = {};
  basicInfo = {};
  currentPhase = 'intro';
  idx = 0;
  rel = '';
  score1 = '';
  score2 = '';
  
  // åˆå§‹åŒ–é é¢
  initializePage();
}

// æ¢å¾©ä¹‹å‰çš„é€²åº¦
function restoreProgress() {
  const savedAnswers = localStorage.getItem(LS_KEY);
  const savedPhase = localStorage.getItem('dematel-phase');
  const savedIdx = localStorage.getItem('dematel-idx');
  
  console.log('=== æ¢å¾©é€²åº¦ ===');
  console.log('savedAnswers:', savedAnswers);
  console.log('savedPhase:', savedPhase);
  console.log('savedIdx:', savedIdx);
  
  if (savedAnswers) {
    answers = JSON.parse(savedAnswers);
    console.log('å·²æ¢å¾©ç­”æ¡ˆ:', answers);
  }
  
  // æ¢å¾©åŸºæœ¬è³‡æ–™
  loadBasicInfoFromLocal();
  
  if (savedPhase) {
    currentPhase = savedPhase;
    console.log('å·²æ¢å¾©éšæ®µ:', currentPhase);
    
    if (currentPhase === 'basic') {
      document.getElementById('introSection').style.display = 'none';
      document.getElementById('basicInfoSection').style.display = 'block';
      loadBasicInfoForm(); // è¼‰å…¥ä¸¦å¡«å……åŸºæœ¬è³‡æ–™è¡¨å–®
    } else if (currentPhase === 'survey') {
      document.getElementById('introSection').style.display = 'none';
      document.getElementById('basicInfoSection').style.display = 'none';
      document.getElementById('surveySection').style.display = 'block';
      
      // ä½¿ç”¨å„²å­˜çš„ idx å€¼ï¼Œå¦‚æœæ²’æœ‰å‰‡ç”¨ findLastAnsweredQuestion() ä½œç‚ºå‚™æ¡ˆ
      if (savedIdx !== null && savedIdx !== undefined && savedIdx !== '') {
        idx = parseInt(savedIdx, 10);
        console.log('ä½¿ç”¨å„²å­˜çš„ idx:', idx);
        
        // é©—è­‰å„²å­˜çš„ idx æ˜¯å¦åˆç†ï¼Œå¦‚æœä¸åˆç†å‰‡é‡æ–°è¨ˆç®—
        if (idx < 0 || idx >= questions.length) {
          console.log('å„²å­˜çš„ idx ä¸åˆç†ï¼Œé‡æ–°è¨ˆç®—');
          idx = findLastAnsweredQuestion();
        }
      } else {
        // æ‰¾åˆ°æœ€å¾Œç­”é¡Œçš„ä½ç½®ä½œç‚ºå‚™æ¡ˆ
        idx = findLastAnsweredQuestion();
        console.log('ä½¿ç”¨è¨ˆç®—çš„ idx:', idx);
      }
      
      console.log('æœ€çµ‚çš„ idx:', idx);
      console.log(`é€™è¡¨ç¤ºå·²å®Œæˆ ${idx} é¡Œï¼Œå°‡é¡¯ç¤ºç¬¬ ${idx + 1} é¡Œ`);
      
      loadSurveyQuestions(false); // æ¢å¾©é€²åº¦æ™‚ä¸é‡ç½® idx
      fillPrev(); // æ¢å¾©ä¹‹å‰çš„é¸æ“‡
      render();
    } else if (currentPhase === 'finish') {
      document.getElementById('introSection').style.display = 'none';
      document.getElementById('basicInfoSection').style.display = 'none';
      document.getElementById('surveySection').style.display = 'none';
      document.getElementById('finishSection').style.display = 'block';
    }
    
    updateProgress();
  }
}

// æ‰¾åˆ°æœ€å¾Œç­”é¡Œçš„ä½ç½®
function findLastAnsweredQuestion() {
  let lastAnsweredIndex = -1; // å¾ -1 é–‹å§‹ï¼Œè¡¨ç¤ºé‚„æ²’æœ‰å›ç­”ä»»ä½•é¡Œç›®
  
  console.log('=== findLastAnsweredQuestion Debug ===');
  console.log('Total questions:', questions.length);
  console.log('Current answers:', answers);
  
  // æª¢æŸ¥æ¯å€‹é¡Œç›®æ˜¯å¦å·²ç¶“å›ç­”
  for (let i = 0; i < questions.length; i++) {
    const q = questions[i];
    let answerKey;
    
    if (q.key) {
      // ä½¿ç”¨æ–°çš„ key æ ¼å¼
      answerKey = q.key;
    } else {
      // å…¼å®¹èˆŠæ ¼å¼
      answerKey = `${q.A.name}_${q.B.name}`;
    }
    
    console.log(`Question ${i}: key=${answerKey}, answered=${!!answers[answerKey]}`);
    
    if (answers[answerKey]) {
      lastAnsweredIndex = i; // è¨˜éŒ„æœ€å¾Œå›ç­”çš„é¡Œç›®ç´¢å¼•
    } else {
      // æ‰¾åˆ°ç¬¬ä¸€å€‹æœªå›ç­”çš„é¡Œç›®ï¼Œå°±åœæ­¢
      break;
    }
  }
  
  // ä¸‹ä¸€é¡Œçš„ç´¢å¼• = æœ€å¾Œå›ç­”çš„é¡Œç›®ç´¢å¼• + 1
  const nextQuestionIndex = lastAnsweredIndex + 1;
  
  // å¦‚æœå…¨éƒ¨éƒ½ç­”å®Œäº†ï¼Œåœåœ¨æœ€å¾Œä¸€é¡Œ
  if (nextQuestionIndex >= questions.length) {
    const finalIndex = questions.length - 1;
    console.log('All questions answered, staying at last question:', finalIndex);
    return finalIndex;
  }
  
  console.log('Last answered question index:', lastAnsweredIndex);
  console.log('Next question index (return value):', nextQuestionIndex);
  console.log(`This means: answered ${lastAnsweredIndex + 1} questions, should show question ${nextQuestionIndex + 1}`);
  
  return nextQuestionIndex;
}

// é é¢è¼‰å…¥å®Œæˆ
window.onload = function() {
  loadJSON(fileName);
};

// QR Code ç›¸é—œå‡½æ•¸ (ä¿æŒåŸæœ‰åŠŸèƒ½)
function generateHash(data) {
  const encoder = new TextEncoder();
  const dataBytes = encoder.encode(JSON.stringify(data));
  return crypto.subtle.digest('SHA-256', dataBytes).then(hashBuffer => {
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  });
}

function compressToBase64(jsonString) {
  try {
    const compressed = pako.deflate(jsonString);
    const base64 = btoa(String.fromCharCode.apply(null, compressed));
    return base64;
  } catch (error) {
    console.error('å£“ç¸®å¤±æ•—:', error);
    return null;
  }
}

function decompressFromBase64(base64String) {
  try {
    const compressed = Uint8Array.from(atob(base64String), c => c.charCodeAt(0));
    const decompressed = pako.inflate(compressed, { to: 'string' });
    return decompressed;
  } catch (error) {
    console.error('è§£å£“ç¸®å¤±æ•—:', error);
    return null;
  }
}

function createKeyMappings(obj) {
  const keys = Object.keys(obj);
  const dictionary = {};
  const values = {};
  
  keys.forEach((key, index) => {
    const shortKey = String.fromCharCode(97 + index);
    dictionary[shortKey] = key;
    values[shortKey] = obj[key];
  });
  
  return { d: dictionary, v: values };
}

function restoreFromKeyMappings(d, v) {
  const restored = {};
  Object.keys(v).forEach(shortKey => {
    const originalKey = d[shortKey];
    if (originalKey) {
      restored[originalKey] = v[shortKey];
    }
  });
  return restored;
}

function splitIntoSegments(base64String, maxLength = 800) {
  if (base64String.length <= maxLength) {
    return [{ i: 0, total: 1, part: base64String }];
  }
  
  // è¨ˆç®—æœ€ä½³ç‰‡æ®µæ•¸ï¼Œè®“æ¯å€‹ç‰‡æ®µå¤§å°æ›´å¹³è¡¡
  const totalLength = base64String.length;
  const idealSegmentCount = Math.ceil(totalLength / maxLength);
  const optimalSegmentLength = Math.ceil(totalLength / idealSegmentCount);
  
  const segments = [];
  let index = 0;
  
  for (let i = 0; i < base64String.length; i += optimalSegmentLength) {
    const part = base64String.substring(i, i + optimalSegmentLength);
    segments.push({
      i: index,
      total: idealSegmentCount,
      part: part
    });
    index++;
  }
  
  return segments;
}

// é©—è­‰å®Œæ•´æ€§çš„å‡½æ•¸
function validateCompletion() {
  // 1. é©—è­‰åŸºæœ¬è³‡æ–™å®Œæ•´æ€§
  if (!validateBasicInfo()) {
    alert('è«‹å…ˆå®Œæ•´å¡«å¯«åŸºæœ¬è³‡æ–™ä¸­çš„å¿…å¡«æ¬„ä½');
    return false;
  }
  
  // 2. é©—è­‰å•å·å®Œæ•´æ€§
  if (!questions || questions.length === 0) {
    alert('å•å·å°šæœªè¼‰å…¥å®Œæˆï¼Œè«‹ç¨å€™å†è©¦');
    return false;
  }
  
  const totalQuestions = questions.length;
  const completedQuestions = Object.keys(answers).length;
  
  if (completedQuestions < totalQuestions) {
    alert(`å•å·å°šæœªå®Œæˆï¼æ‚¨å·²å®Œæˆ ${completedQuestions} é¡Œï¼Œé‚„æœ‰ ${totalQuestions - completedQuestions} é¡Œæœªå®Œæˆã€‚`);
    return false;
  }
  
  // 3. é©—è­‰æ¯å€‹ç­”æ¡ˆçš„å®Œæ•´æ€§
  for (let i = 0; i < questions.length; i++) {
    const q = questions[i];
    const answer = answers[q.key];
    
    if (!answer) {
      alert(`ç¬¬ ${i + 1} é¡Œç­”æ¡ˆéºå¤±ï¼Œè«‹é‡æ–°æª¢æŸ¥å•å·`);
      return false;
    }
    
    if (answer.relation === 'to' && !answer.score) {
      alert(`ç¬¬ ${i + 1} é¡Œå½±éŸ¿ç¨‹åº¦åˆ†æ•¸éºå¤±`);
      return false;
    }
    
    if (answer.relation === 'from' && !answer.score) {
      alert(`ç¬¬ ${i + 1} é¡Œå½±éŸ¿ç¨‹åº¦åˆ†æ•¸éºå¤±`);
      return false;
    }
    
    if (answer.relation === 'bi' && (!answer.score_XtoY || !answer.score_YtoX)) {
      alert(`ç¬¬ ${i + 1} é¡Œé›™å‘å½±éŸ¿åˆ†æ•¸ä¸å®Œæ•´`);
      return false;
    }
  }
  
  return true;
}

// é©—è­‰å¾Œä¸‹è¼‰
function validateAndDownload() {
  if (validateCompletion()) {
    download();
  }
}

// é©—è­‰å¾Œç”¢ç”ŸQR Code
function validateAndShowQRCode() {
  if (validateCompletion()) {
    showQRCode();
  }
}

async function showQRCode() {
  console.log('=== QR Code ç”¢ç”Ÿæµç¨‹é–‹å§‹ ===');
  
  // 1. æº–å‚™å®Œæ•´è³‡æ–™ (åŸºæœ¬è³‡æ–™ + å•å·ç­”æ¡ˆ)
  const fullData = {
    basicInfo: basicInfo,
    answers: answers,
    metadata: {
      timestamp: new Date().toISOString(),
      totalQuestions: questions.length,
      completedQuestions: Object.keys(answers).length
    }
  };
  console.log('å®Œæ•´è³‡æ–™:', fullData);
  
  // 2. ç¸®çŸ­ key ä¸¦å»ºç«‹å­—å…¸
  const { d, v } = createKeyMappings(fullData);
  console.log('å­—å…¸ (d):', d);
  console.log('ç¸®çŸ­å¾Œçš„å€¼ (v):', v);
  
  // 3. ç”¢ç”Ÿ SHA-256 hash
  const hash = await generateHash(v);
  console.log('SHA-256 hash (h):', hash);
  
  // 4. æ‰“åŒ…è³‡æ–™
  const packagedData = { d, v, h: hash };
  const jsonString = JSON.stringify(packagedData);
  console.log('æ‰“åŒ…å¾Œçš„ JSON:', jsonString);
  
  // 5. å£“ç¸®ä¸¦è½‰ base64
  const compressedBase64 = compressToBase64(jsonString);
  if (!compressedBase64) {
    alert('è³‡æ–™å£“ç¸®å¤±æ•—');
    return;
  }
  
  console.log('å£“ç¸®å¾Œçš„ base64 é•·åº¦:', compressedBase64.length);
  
  // 6. åˆ†å‰²æˆç‰‡æ®µ
  const segments = splitIntoSegments(compressedBase64);
  console.log('åˆ†å‰²ç‰‡æ®µ:', segments);
  
  // 7. ç”¢ç”ŸQR Code
  const qrWrap = document.getElementById('qrcode-wrap');
  const qrSegments = document.getElementById('qrcode-segments');
  
  qrSegments.innerHTML = '';
  
  // æ·»åŠ èªªæ˜æ–‡å­—
  const instructionDiv = document.createElement('div');
  instructionDiv.style.width = '100%';
  instructionDiv.style.textAlign = 'center';
  instructionDiv.style.marginBottom = '20px';
  instructionDiv.style.padding = '15px';
  instructionDiv.style.backgroundColor = '#e3f2fd';
  instructionDiv.style.borderRadius = '8px';
  instructionDiv.style.border = '1px solid #2196f3';
  instructionDiv.innerHTML = `
    <h4 style="color: #1976d2; margin: 0 0 10px 0;">ğŸ“± æˆªåœ–èªªæ˜</h4>
    <p style="margin: 0; color: #1565c0; font-size: 0.95em;">
      è«‹å°‡ä¸‹æ–¹<strong>æ‰€æœ‰QR Code</strong>åˆ†åˆ¥æˆªåœ–ï¼Œä¸¦å°‡æˆªåœ–æª”æ¡ˆå›å‚³çµ¦ç ”ç©¶äººå“¡ã€‚<br>
      æ¯å€‹QR Codeéƒ½åŒ…å«å•å·è³‡æ–™çš„ä¸€éƒ¨åˆ†ï¼Œç¼ºä¸€ä¸å¯ã€‚
    </p>
  `;
  qrSegments.appendChild(instructionDiv);
  
  segments.forEach((segment, index) => {
    const segmentDiv = document.createElement('div');
    segmentDiv.className = 'qr-segment';
    
    const title = document.createElement('h4');
    title.textContent = `ç¬¬ ${index + 1} å€‹ QR Codeï¼ˆå…± ${segments.length} å€‹ï¼‰`;
    segmentDiv.appendChild(title);
    
    // æ·»åŠ è³‡æ–™é‡èªªæ˜
    const sizeInfo = document.createElement('p');
    sizeInfo.style.fontSize = '0.85em';
    sizeInfo.style.color = '#666';
    sizeInfo.style.margin = '5px 0 10px 0';
    sizeInfo.textContent = `è³‡æ–™é‡: ${segment.part.length} å­—å…ƒ`;
    segmentDiv.appendChild(sizeInfo);
    
    const qrDiv = document.createElement('div');
    qrDiv.id = `qr-${index}`;
    qrDiv.style.margin = '15px auto';
    segmentDiv.appendChild(qrDiv);
    
    // éš±è—åŸå§‹è³‡æ–™ï¼Œåªåœ¨éœ€è¦æ™‚é¡¯ç¤º
    const showDataBtn = document.createElement('button');
    showDataBtn.textContent = 'é¡¯ç¤ºåŸå§‹è³‡æ–™';
    showDataBtn.style.fontSize = '0.8em';
    showDataBtn.style.padding = '5px 10px';
    showDataBtn.style.marginTop = '10px';
    showDataBtn.style.backgroundColor = '#f8f9fa';
    showDataBtn.style.border = '1px solid #ddd';
    showDataBtn.style.borderRadius = '4px';
    showDataBtn.style.cursor = 'pointer';
    
    const pre = document.createElement('pre');
    pre.style.fontSize = '0.7em';
    pre.style.wordBreak = 'break-all';
    pre.style.backgroundColor = '#f8f9fa';
    pre.style.padding = '8px';
    pre.style.borderRadius = '4px';
    pre.style.marginTop = '8px';
    pre.style.display = 'none';
    pre.textContent = JSON.stringify(segment);
    
    showDataBtn.onclick = function() {
      if (pre.style.display === 'none') {
        pre.style.display = 'block';
        showDataBtn.textContent = 'éš±è—åŸå§‹è³‡æ–™';
      } else {
        pre.style.display = 'none';
        showDataBtn.textContent = 'é¡¯ç¤ºåŸå§‹è³‡æ–™';
      }
    };
    
    segmentDiv.appendChild(showDataBtn);
    segmentDiv.appendChild(pre);
    
    qrSegments.appendChild(segmentDiv);
    
    // ç”¢ç”ŸQR Code
    new QRCode(qrDiv, {
      text: JSON.stringify(segment),
      width: 240,
      height: 240,
      colorDark: "#000000",
      colorLight: "#ffffff",
      correctLevel: QRCode.CorrectLevel.M
    });
  });
  
  qrWrap.style.display = 'block';
}

function hideQRCode() {
  document.getElementById('qrcode-wrap').style.display = 'none';
}

async function verifyAndRestore() {
  const input = document.getElementById('verificationInput').value.trim();
  const resultArea = document.getElementById('verificationResult');
  
  if (!input) {
    resultArea.innerHTML = '<div style="color: #e74c3c;">è«‹è¼¸å…¥è¦é©—è­‰çš„è³‡æ–™</div>';
    return;
  }
  
  try {
    // è§£æè¼¸å…¥çš„ç‰‡æ®µ
    const lines = input.split('\n').filter(line => line.trim());
    const segments = lines.map(line => JSON.parse(line.trim()));
    
    // æ’åºç‰‡æ®µ
    segments.sort((a, b) => a.i - b.i);
    
    // é‡çµ„ base64
    const reconstructedBase64 = segments.map(s => s.part).join('');
    
    // è§£å£“ç¸®
    const decompressed = decompressFromBase64(reconstructedBase64);
    if (!decompressed) {
      throw new Error('è§£å£“ç¸®å¤±æ•—');
    }
    
    // è§£æ JSON
    const packagedData = JSON.parse(decompressed);
    const { d, v, h } = packagedData;
    
    // é©—è­‰ hash
    const calculatedHash = await generateHash(v);
    if (calculatedHash !== h) {
      resultArea.innerHTML = '<div style="color: #e74c3c;">âŒ é©—è­‰å¤±æ•—ï¼šè³‡æ–™å¯èƒ½å·²è¢«ç¯¡æ”¹</div>';
      return;
    }
    
    // é‚„åŸåŸå§‹è³‡æ–™
    const restored = restoreFromKeyMappings(d, v);
    
    resultArea.innerHTML = `
      <div style="color: #28a745; margin-bottom: 10px;">âœ… é©—è­‰æˆåŠŸï¼šè³‡æ–™å®Œæ•´ä¸”æœªè¢«ç¯¡æ”¹</div>
      <div style="margin-bottom: 10px;"><strong>é‚„åŸçš„åŸå§‹è³‡æ–™ï¼š</strong></div>
      <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; max-height: 300px; overflow-y: auto;">${JSON.stringify(restored, null, 2)}</pre>
    `;
    
  } catch (error) {
    resultArea.innerHTML = `<div style="color: #e74c3c;">âŒ é©—è­‰å¤±æ•—ï¼š${error.message}</div>`;
  }
}

function download() {
  const fullData = {
    basicInfo: basicInfo,
    answers: answers,
    metadata: {
      timestamp: new Date().toISOString(),
      totalQuestions: questions.length,
      completedQuestions: Object.keys(answers).length
    }
  };
  
  const blob = new Blob([JSON.stringify(fullData, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `dematel-survey-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

// è¨ºæ–·å·¥å…·å‡½æ•¸
function toggleDebugPanel() {
  const panel = document.getElementById('debugPanel');
  panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

function checkLocalStorage() {
  const debugInfo = document.getElementById('debugInfo');
  let html = '<div style="margin-top: 10px; font-size: 11px;">';
  
  try {
    // æª¢æŸ¥ localStorage æ”¯æ´
    html += `<div>localStorage æ”¯æ´: ${typeof(Storage) !== "undefined" ? "âœ“" : "âœ—"}</div>`;
    
    // æª¢æŸ¥å„é …å„²å­˜å…§å®¹
    const dematelAnswers = localStorage.getItem(LS_KEY);
    const dematelPhase = localStorage.getItem('dematel-phase');
    const dematelIdx = localStorage.getItem('dematel-idx');
    const dematelLastSave = localStorage.getItem('dematel-last-save');
    
    html += `<div>dematel_answers: ${dematelAnswers ? "æœ‰è³‡æ–™ (" + dematelAnswers.length + " å­—å…ƒ)" : "ç„¡"}</div>`;
    html += `<div>dematel-phase: ${dematelPhase || "ç„¡"}</div>`;
    html += `<div>dematel-idx: ${dematelIdx || "ç„¡"}</div>`;
    html += `<div>æœ€å¾Œä¿å­˜: ${dematelLastSave || "ç„¡"}</div>`;
    
    // é¡¯ç¤ºç•¶å‰è¨˜æ†¶é«”ä¸­çš„è®Šæ•¸
    html += `<div style="margin-top: 5px;">è¨˜æ†¶é«”ç‹€æ…‹:</div>`;
    html += `<div>answers ç‰©ä»¶: ${Object.keys(answers).length} é …</div>`;
    html += `<div>currentPhase: ${currentPhase}</div>`;
    html += `<div>idx: ${idx}</div>`;
    html += `<div>rel: ${rel}</div>`;
    
    // æ¸¬è©¦å„²å­˜åŠŸèƒ½
    try {
      localStorage.setItem('test-write', 'test');
      localStorage.removeItem('test-write');
      html += `<div>å„²å­˜æ¸¬è©¦: âœ“</div>`;
    } catch(e) {
      html += `<div>å„²å­˜æ¸¬è©¦: âœ— (${e.message})</div>`;
    }
    
  } catch(e) {
    html += `<div>æª¢æŸ¥éŒ¯èª¤: ${e.message}</div>`;
  }
  
  html += '</div>';
  debugInfo.innerHTML = html;
}

function clearDebugStorage() {
  if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ localStorage è³‡æ–™å—ï¼Ÿ')) {
    clearAllData();
    checkLocalStorage();
    alert('å·²æ¸…é™¤æ‰€æœ‰å„²å­˜è³‡æ–™');
  }
}
</script>

</body>
</html>
